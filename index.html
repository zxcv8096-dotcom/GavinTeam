<script>
  // Supabase 設定
  const SUPABASE_URL = 'https://dgyizyaqxxmjcqspnlvm.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_s2Vxi5ap4xLgrQNTYSh3qg_TSmPwGTO';

  // ✅ 不要叫 supabase，避免跟 window.supabase 撞名
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // 1. 檢查登入狀態
  async function checkSession() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) {
      showApp(session.user);
    } else {
      document.getElementById('login-section').style.display = 'block';
      document.getElementById('app-section').style.display = 'none';
      document.getElementById('header-content').style.display = 'block';
    }
  }

  // ✅ 讓 HTML onclick 找得到
  window.signInWithGoogle = async function () {
    try {
      const cleanRedirect = window.location.origin + window.location.pathname;
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: cleanRedirect,
          queryParams: { access_type: 'offline', prompt: 'consent' },
        }
      });
      if (error) alert("登入錯誤: " + error.message);
    } catch (err) {
      alert("發生未預期的錯誤: " + (err?.message || err));
    }
  }

  // 3. 顯示主程式
  function showApp(user) {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('header-content').style.display = 'none';
    document.getElementById('app-section').style.display = 'block';
    document.getElementById('user-badge').innerText = `管理員已登入: ${user.email}`;
    document.getElementById('user-badge').style.display = 'inline-block';
  }

  // 4. 計算邏輯
  window.calculate = function () {
    const target = parseFloat(document.getElementById('target').value);
    const budget = parseFloat(document.getElementById('budget').value);
    if (!target || !budget) return alert("請輸入完整數值");

    const leads = Math.floor(budget / 35);
    const resultElement = document.getElementById('leads-result');

    let current = 0;
    const timer = setInterval(() => {
      current += Math.ceil(leads / 20);
      if (current >= leads) {
        current = leads;
        clearInterval(timer);
      }
      resultElement.innerText = current + " 名潛在客戶";
    }, 30);

    document.getElementById('result-area').style.display = 'block';
  }

  // 5. 登出
  window.signOut = async function () {
    await supabaseClient.auth.signOut();
    window.location.reload();
  }

  // ✅ 監聽登入狀態變化（登入成功會自動觸發）
  supabaseClient.auth.onAuthStateChange((_event, session) => {
    if (session?.user) showApp(session.user);
  });

  // 初始化檢查
  checkSession();
</script>

<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Worker çµ„è£å¾Œå°ï½œGavinTeam</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:system-ui,"Microsoft JhengHei";}
    textarea, .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace;}
  </style>
</head>

<body class="min-h-screen bg-slate-50">

<script>
/* =========================
 * åªè¦æ”¹é€™è£¡
 * ========================= */
const CONFIG = {
  GIST_ID: "17db93f6b4d4813bcbcfc66cc4ba343f",

  // ğŸ”´ è²¼ã€Œæ–°çš„ã€GitHub Tokenï¼ˆghp_ æˆ– github_pat_ éƒ½å¯ï¼‰
  GITHUB_TOKEN: "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",

  LOGIN_USER: "gavin",
  LOGIN_PASS: "1234",

  FILES: { dev:"worker_dev.json", prod:"worker_prod.json", old:"worker_old.json" }
};
</script>

<script>
/* =========================
 * GitHub APIï¼ˆå·²ä¿®æ­£ 401ï¼‰
 * ========================= */
function authHeaders(){
  const t = (CONFIG.GITHUB_TOKEN || "").trim();

  const h = {
    "Accept": "application/vnd.github+json",
    "X-GitHub-Api-Version": "2022-11-28",
    "User-Agent": "GavinTeam-WorkerBuilder"
  };

  if (!t) return h;

  // â­ é—œéµä¿®æ­£ï¼šè‡ªå‹•åˆ¤æ–· token é¡å‹
  h["Authorization"] = t.startsWith("github_pat_")
    ? `Bearer ${t}`   // fine-grained
    : `token ${t}`;   // classicï¼ˆghp_ï¼‰

  return h;
}

async function readGitHubError(res){
  let txt = "";
  try { txt = await res.text(); } catch {}
  try {
    const j = JSON.parse(txt);
    if (j?.message) return `GitHub ${res.status}ï¼š${j.message}`;
  } catch {}
  return `GitHub ${res.status}ï¼š${txt || res.statusText}`;
}

async function gistGet(){
  const res = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, {
    headers: authHeaders()
  });
  if (!res.ok) throw new Error(await readGitHubError(res));
  return await res.json();
}

async function gistReadFile(slot){
  const gist = await gistGet();
  const file = gist.files?.[CONFIG.FILES[slot]];
  if (!file) throw new Error("æ‰¾ä¸åˆ°æª”æ¡ˆï¼š" + CONFIG.FILES[slot]);
  return file.content || "{}";
}

async function gistWriteFile(slot, content){
  const res = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, {
    method: "PATCH",
    headers: { ...authHeaders(), "Content-Type":"application/json" },
    body: JSON.stringify({
      files: { [CONFIG.FILES[slot]]: { content } }
    })
  });
  if (!res.ok) throw new Error(await readGitHubError(res));
}
</script>

<script>
/* =========================
 * æ¸¬è©¦ç”¨ï¼ˆä½ å¯ç•™è‘—ï¼‰
 * ========================= */
(async ()=>{
  try{
    await gistGet();
    console.log("âœ… GitHub Token æ­£å¸¸ï¼ŒGist å¯å­˜å–");
  }catch(e){
    console.error("âŒ Gist å­˜å–å¤±æ•—ï¼š", e.message);
  }
})();
</script>

<div class="p-6 max-w-xl mx-auto">
  <h1 class="text-xl font-black mb-4">Worker çµ„è£å¾Œå°</h1>

  <input id="projectName" class="w-full border rounded px-3 py-2 mb-2" value="æˆ‘çš„ Worker"/>

  <div class="flex gap-2 mb-3">
    <button onclick="load('dev')" class="px-3 py-2 bg-slate-900 text-white rounded">DEV</button>
    <button onclick="load('prod')" class="px-3 py-2 bg-slate-700 text-white rounded">PROD</button>
    <button onclick="load('old')" class="px-3 py-2 bg-slate-500 text-white rounded">OLD</button>
  </div>

  <textarea id="editor" class="w-full h-40 border rounded p-2 mono mb-2">{}</textarea>

  <div class="flex gap-2">
    <button onclick="save()" class="px-4 py-2 bg-emerald-600 text-white rounded">å„²å­˜</button>
    <button onclick="load(current)" class="px-4 py-2 bg-slate-200 rounded">é‡æ–°è®€å–</button>
  </div>

  <div id="msg" class="text-sm mt-3"></div>
</div>

<script>
let current = "dev";

async function load(slot){
  current = slot;
  try{
    const txt = await gistReadFile(slot);
    document.getElementById("editor").value = txt;
    document.getElementById("msg").textContent = "âœ… å·²è®€å– " + slot;
  }catch(e){
    document.getElementById("msg").textContent = "âŒ " + e.message;
  }
}

async function save(){
  try{
    await gistWriteFile(current, document.getElementById("editor").value);
    document.getElementById("msg").textContent = "âœ… å·²å„²å­˜";
  }catch(e){
    document.getElementById("msg").textContent = "âŒ " + e.message;
  }
}
</script>

</body>
</html>

<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Worker çµ„è£å¾Œå°ï½œGavinTeam</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:system-ui,"Microsoft JhengHei";}
    textarea,.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace;}
    .shadow-soft{box-shadow:0 10px 30px rgba(2,6,23,.06);}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border-radius:14px;padding:.6rem .95rem;font-weight:900;font-size:12px}
    .btn-primary{background:#0f172a;color:#fff}
    .btn-ghost{border:1px solid #e5e7eb;background:#fff}
    .chip{border:1px solid #e5e7eb;border-radius:999px;padding:.35rem .7rem;font-size:12px;font-weight:900}
    .chip-on{background:#0f172a;color:#fff}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:24px}
  </style>
</head>

<body class="min-h-screen bg-slate-50">

<script>
/* =========================
 * âœ… ä½ åªè¦æ”¹é€™è£¡
 * ========================= */
const CONFIG = {
  GIST_ID: "17db93f6b4d4813bcbcfc66cc4ba343f",
  GITHUB_TOKEN: "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",
  LOGIN_USER: "gavin",
  LOGIN_PASS: "1234",
  FILES: { dev:"worker_dev.json", prod:"worker_prod.json", old:"worker_old.json" }
};
</script>

<script>
/* =====================================================
 * ğŸ”§ æ ¸å¿ƒä¿®æ­£ï¼ˆä¸€æ¬¡è§£æ±ºä½ æ‰€æœ‰éŒ¯èª¤ï¼‰
 * ===================================================== */

// æ¸…ç† tokenï¼ˆç§»é™¤æ›è¡Œã€å…¨å½¢ã€ä¸­æ–‡ã€ä¸å¯è¦‹å­—å…ƒï¼‰
function cleanToken(input){
  return String(input||"")
    .trim()
    .replace(/\s+/g,"")
    .replace(/[^\x20-\x7E]/g,"");
}

function authHeaders(){
  const t = cleanToken(CONFIG.GITHUB_TOKEN);
  const h = {
    "Accept":"application/vnd.github+json",
    "X-GitHub-Api-Version":"2022-11-28"
  };
  if(!t) return h;
  h["Authorization"] = t.startsWith("github_pat_")
    ? `Bearer ${t}`   // fine-grained
    : `token ${t}`;   // classic
  return h;
}

async function readGitHubError(res){
  let txt = await res.text();
  try {
    const j = JSON.parse(txt);
    return `GitHub ${res.status}ï¼š${j.message||txt}`;
  } catch {
    return `GitHub ${res.status}ï¼š${txt||res.statusText}`;
  }
}

/* =========================
 * Gist API
 * ========================= */
async function gistGet(){
  const r = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`,{
    headers: authHeaders()
  });
  if(!r.ok) throw new Error(await readGitHubError(r));
  return r.json();
}
async function gistReadFile(slot){
  const g = await gistGet();
  const f = g.files?.[CONFIG.FILES[slot]];
  if(!f) throw new Error("æ‰¾ä¸åˆ°æª”æ¡ˆï¼š"+CONFIG.FILES[slot]);
  return f.content || "{}";
}
async function gistWriteFile(slot, content){
  const r = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`,{
    method:"PATCH",
    headers:{...authHeaders(),"Content-Type":"application/json"},
    body:JSON.stringify({files:{[CONFIG.FILES[slot]]:{content}}})
  });
  if(!r.ok) throw new Error(await readGitHubError(r));
}

/* =========================
 * UI + ç‹€æ…‹
 * ========================= */
const $ = id => document.getElementById(id);
let slot="dev";
let project={name:"æˆ‘çš„ Worker",modules:[]};

async function loadSlot(s){
  slot=s;
  const raw=await gistReadFile(slot);
  project=JSON.parse(raw||"{}");
  if(!project.modules) project={name:"æˆ‘çš„ Worker",modules:[]};
  $("editor").value=JSON.stringify(project,null,2);
  $("msg").textContent="âœ… å·²è®€å– "+slot;
}
async function saveSlot(){
  project=JSON.parse($("editor").value||"{}");
  await gistWriteFile(slot, JSON.stringify(project,null,2));
  $("msg").textContent="âœ… å·²å„²å­˜ "+slot;
}
</script>

<div class="max-w-3xl mx-auto p-6">
  <div class="card p-4 shadow-soft">
    <h1 class="text-xl font-black mb-3">Worker çµ„è£å¾Œå°ï¼ˆå®Œæ•´ç‰ˆï¼‰</h1>

    <div class="flex gap-2 mb-3">
      <button class="chip chip-on" onclick="loadSlot('dev')">DEV</button>
      <button class="chip" onclick="loadSlot('prod')">PROD</button>
      <button class="chip" onclick="loadSlot('old')">OLD</button>
    </div>

    <textarea id="editor" class="w-full h-64 border rounded p-3 mono"></textarea>

    <div class="flex gap-2 mt-3">
      <button class="btn btn-primary" onclick="saveSlot()">å„²å­˜</button>
      <button class="btn btn-ghost" onclick="loadSlot(slot)">é‡æ–°è®€å–</button>
    </div>

    <div id="msg" class="text-sm mt-3 text-slate-600"></div>
  </div>
</div>

<script>
/* =========================
 * åˆå§‹åŒ–
 * ========================= */
(async()=>{
  try{
    await loadSlot("dev");
  }catch(e){
    $("msg").textContent="âŒ "+e.message;
  }
})();
</script>

</body>
</html>

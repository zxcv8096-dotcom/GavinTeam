<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Worker 組裝後台｜GavinTeam（SE 太空戰士風）</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* =========================================================
       SE / Final Fantasy-ish Sci-Fi HUD Theme (no images)
       - Dark space + nebula glow
       - Holographic glass panels
       - Grid + scanlines + subtle noise
       - Neon accents, crisp outlines, HUD chips
       ========================================================= */
    :root{
      --bg0:#050712;
      --bg1:#070a1a;
      --ink:#e7ecff;
      --muted:#9aa8d6;

      --cyan:#57e6ff;
      --blue:#7aa6ff;
      --violet:#b38bff;
      --green:#42ffb5;
      --amber:#ffcf6a;
      --red:#ff5a7a;

      --bd: rgba(120,160,255,.22);
      --bd2: rgba(87,230,255,.18);

      --glass: rgba(12,18,40,.50);
      --glass2: rgba(10,14,30,.42);

      --shadow: 0 28px 90px rgba(0,0,0,.60);
      --shadow2: 0 14px 40px rgba(0,0,0,.45);

      --ring: 0 0 0 3px rgba(87,230,255,.18), 0 0 0 9px rgba(122,166,255,.10);
    }

    body{
      font-family:system-ui,"Microsoft JhengHei";
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 15% 8%, rgba(179,139,255,.24), transparent 60%),
        radial-gradient(1000px 620px at 85% 18%, rgba(87,230,255,.18), transparent 55%),
        radial-gradient(950px 550px at 50% 90%, rgba(66,255,181,.10), transparent 60%),
        radial-gradient(700px 520px at 65% 40%, rgba(122,166,255,.10), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      -webkit-text-size-adjust:100%;
      overflow-x:hidden;
    }

    textarea, .mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }

    /* Background HUD overlays */
    .hud-bg{
      position:fixed; inset:0; pointer-events:none; z-index:0;
    }
    .hud-bg::before{
      /* grid */
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(rgba(87,230,255,.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(87,230,255,.05) 1px, transparent 1px);
      background-size: 42px 42px;
      mask-image: radial-gradient(circle at 50% 50%, rgba(0,0,0,.9), rgba(0,0,0,.25) 55%, transparent 80%);
      opacity:.55;
      filter: blur(.0px);
    }
    .hud-bg::after{
      /* scanlines + subtle noise */
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,.04),
          rgba(255,255,255,.04) 1px,
          rgba(0,0,0,0) 2px,
          rgba(0,0,0,0) 6px
        );
      opacity:.18;
      mix-blend-mode: overlay;
    }

    /* Top glow strip */
    .top-glow{
      position:fixed;
      inset:-220px -220px auto -220px;
      height:420px;
      background:
        radial-gradient(closest-side at 25% 65%, rgba(87,230,255,.26), transparent 65%),
        radial-gradient(closest-side at 70% 40%, rgba(179,139,255,.22), transparent 65%),
        radial-gradient(closest-side at 90% 70%, rgba(66,255,181,.14), transparent 65%);
      filter: blur(14px);
      pointer-events:none;
      z-index:0;
      opacity:.9;
    }

    /* Panels */
    .card{
      background: linear-gradient(180deg, rgba(12,18,40,.62), rgba(10,14,30,.46));
      border:1px solid var(--bd);
      border-radius:22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      /* holographic edge */
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(135deg, rgba(87,230,255,.20), rgba(179,139,255,.16), rgba(66,255,181,.10));
      opacity:.35;
      filter: blur(10px);
      pointer-events:none;
    }
    .card-inner{
      position:relative;
      background: linear-gradient(180deg, rgba(6,10,22,.45), rgba(6,10,22,.32));
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      padding:16px;
    }

    /* Inputs */
    input, textarea{
      color: var(--ink);
      border:1px solid rgba(122,166,255,.22) !important;
      background: rgba(8,12,26,.55) !important;
    }
    input::placeholder, textarea::placeholder{ color: rgba(154,168,214,.55); }
    input:focus, textarea:focus{
      outline:none;
      box-shadow: var(--ring);
      border-color: rgba(87,230,255,.55) !important;
    }

    /* Buttons */
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:.5rem;
      border-radius:14px;
      padding:.62rem .95rem;
      font-weight:900;
      font-size:12px;
      user-select:none;
      transition: transform .08s ease, filter .2s ease, background .2s ease, border-color .2s ease;
      position:relative;
      overflow:hidden;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }

    .btn-primary{
      color:#061018;
      background:
        linear-gradient(135deg, rgba(87,230,255,1), rgba(122,166,255,1));
      box-shadow: 0 18px 34px rgba(87,230,255,.18);
      border: 1px solid rgba(255,255,255,.18);
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
    }
    .btn-primary:hover{ filter: brightness(1.06); }
    .btn-primary::after{
      /* shimmer */
      content:"";
      position:absolute;
      top:-40%;
      left:-60%;
      width:50%;
      height:180%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.45), transparent);
      transform: rotate(18deg);
      opacity:.0;
      transition: opacity .2s ease, left .6s ease;
    }
    .btn-primary:hover::after{ opacity:.65; left:120%; }

    .btn-ghost{
      color: var(--ink);
      border:1px solid rgba(87,230,255,.22);
      background: rgba(10,14,30,.35);
      box-shadow: 0 12px 26px rgba(0,0,0,.28);
    }
    .btn-ghost:hover{
      background: rgba(12,18,40,.55);
      border-color: rgba(87,230,255,.38);
      filter: brightness(1.03);
    }

    /* Chips / badges */
    .chip{
      border:1px solid rgba(122,166,255,.28);
      border-radius:999px;
      padding:.36rem .72rem;
      font-size:12px;
      font-weight:900;
      color: rgba(231,236,255,.92);
      background: rgba(8,12,26,.40);
      transition: all .2s ease;
      position:relative;
    }
    .chip:hover{
      border-color: rgba(87,230,255,.55);
      box-shadow: 0 0 0 1px rgba(87,230,255,.10), 0 0 26px rgba(87,230,255,.10);
    }
    .chip-on{
      border-color: rgba(87,230,255,.70);
      background: linear-gradient(135deg, rgba(87,230,255,.22), rgba(179,139,255,.12));
      box-shadow: 0 0 0 1px rgba(87,230,255,.14), 0 0 36px rgba(87,230,255,.12);
    }

    .badge{border-radius:999px;padding:.2rem .6rem;font-size:11px;font-weight:900}
    .badge-dev{background: rgba(87,230,255,.14); color: rgba(87,230,255,.92); border:1px solid rgba(87,230,255,.28)}
    .badge-prod{background: rgba(66,255,181,.12); color: rgba(66,255,181,.92); border:1px solid rgba(66,255,181,.24)}
    .badge-old{background: rgba(255,207,106,.12); color: rgba(255,207,106,.95); border:1px solid rgba(255,207,106,.22)}

    .pill{
      border:1px solid rgba(122,166,255,.22);
      border-radius:999px;
      padding:.25rem .65rem;
      font-size:11px;
      font-weight:900;
      background: rgba(8,12,26,.36);
      color: rgba(231,236,255,.92);
    }

    /* Rows */
    .row{
      border:1px solid rgba(122,166,255,.18);
      border-radius:16px;
      padding:10px;
      background: rgba(8,12,26,.34);
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
      position:relative;
      overflow:hidden;
    }
    .row::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(87,230,255,.08), transparent);
      transform: translateX(-120%);
      transition: transform .7s ease;
      pointer-events:none;
    }
    .row:hover{
      background: rgba(12,18,40,.46);
      border-color: rgba(87,230,255,.28);
      transform: translateY(-1px);
    }
    .row:hover::before{ transform: translateX(120%); }

    .handle{cursor:grab; color: rgba(154,168,214,.8)}
    .handle:active{cursor:grabbing}

    /* Toast */
    .toast-wrap{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    .toast{
      pointer-events:none;
      min-width: 300px;
      max-width: 440px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(122,166,255,.22);
      background: rgba(8,12,26,.62);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 22px 65px rgba(0,0,0,.55);
      display:flex;align-items:flex-start;gap:10px;
      transform: translateY(10px);
      opacity: 0;
      animation: toastIn .22s ease forwards;
      position:relative;
      overflow:hidden;
    }
    .toast::before{
      content:"";
      position:absolute; inset:-1px;
      background: linear-gradient(135deg, rgba(87,230,255,.18), rgba(179,139,255,.12), rgba(66,255,181,.10));
      opacity:.35;
      filter: blur(14px);
      pointer-events:none;
    }
    .toast.hide{ animation: toastOut .22s ease forwards; }
    .toast .dot{
      margin-top: 4px;
      width:10px;height:10px;border-radius:999px;
      flex: 0 0 auto;
      box-shadow: 0 0 0 6px rgba(87,230,255,.10);
      position:relative;
      z-index:1;
    }
    .toast.ok .dot{ background: var(--green); box-shadow: 0 0 0 6px rgba(66,255,181,.12); }
    .toast.err .dot{ background: var(--red); box-shadow: 0 0 0 6px rgba(255,90,122,.12); }
    .toast .t{
      font-weight: 900;
      font-size: 12px;
      color: rgba(231,236,255,.96);
      line-height: 1.35;
      word-break: break-word;
      position:relative;
      z-index:1;
    }
    .toast .s{
      margin-top:2px;
      font-size: 11px;
      color: rgba(154,168,214,.85);
      position:relative;
      z-index:1;
    }
    @keyframes toastIn{ from{ opacity:0; transform: translateY(12px);} to{ opacity:1; transform: translateY(0);} }
    @keyframes toastOut{ from{ opacity:1; transform: translateY(0);} to{ opacity:0; transform: translateY(10px);} }
  </style>
</head>

<body class="min-h-screen">
  <div class="hud-bg"></div>
  <div class="top-glow"></div>

<script>
/** =========================
 * ✅ 你只要改這裡
 * ========================= */
const CONFIG = {
  GIST_ID: "17db93f6b4d4813bcbcfc66cc4ba343f",
  LOGIN_USER: "gavin",
  LOGIN_PASS: "1234",
  FILES: { dev:"worker_dev.json", prod:"worker_prod.json", old:"worker_old.json" }
};
</script>

<!-- Toast -->
<div id="toastWrap" class="toast-wrap"></div>

<!-- ===== 登入畫面 ===== -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center p-6 relative z-10">
  <div class="w-full max-w-md card p-4">
    <div class="card-inner">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-cyan-400/20 border border-cyan-200/20 text-cyan-100 flex items-center justify-center font-black">
          G
        </div>
        <div class="min-w-0">
          <div class="text-lg font-extrabold">GavinTeam · Worker 組裝後台</div>
          <div class="text-xs opacity-80 mt-0.5">Sci-Fi HUD Mode</div>
        </div>
      </div>

      <div class="mt-5 space-y-3">
        <div>
          <label class="text-xs font-bold opacity-80">帳號</label>
          <input id="user" class="mt-1 w-full px-3 py-2 rounded-2xl text-sm" placeholder="輸入帳號">
        </div>
        <div>
          <label class="text-xs font-bold opacity-80">密碼</label>
          <input id="pass" type="password" class="mt-1 w-full px-3 py-2 rounded-2xl text-sm" placeholder="輸入密碼">
        </div>

        <button id="loginBtn" class="btn btn-primary w-full">登入</button>
        <div id="loginMsg" class="text-xs text-rose-300"></div>
      </div>

      <div class="mt-5 text-[11px] opacity-75">
        DEV｜PROD｜OLD（切換後自動讀取對應雲端檔案）
      </div>
    </div>
  </div>
</div>

<!-- ===== 主畫面 ===== -->
<div id="app" class="hidden relative z-10">
  <!-- Top bar -->
  <div class="sticky top-0 z-20 bg-black/25 backdrop-blur border-b border-white/5">
    <div class="max-w-7xl mx-auto px-5 py-4 flex items-center justify-between gap-3">
      <div class="min-w-0">
        <div class="flex items-center gap-2 flex-wrap">
          <div class="text-xl font-extrabold">Worker 組裝後台</div>
          <span id="slotBadge" class="badge badge-dev">DEV</span>
          <span id="tokenStatePill" class="pill">Token：未載入</span>
        </div>
        <div class="text-xs opacity-80 mt-1">
          狀態切換會自動讀取雲端檔案；輸出前請先按「組裝」。
        </div>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <button id="slotDev"  class="chip chip-on">開發中</button>
        <button id="slotProd" class="chip">已上線</button>
        <button id="slotOld"  class="chip">舊檔</button>
        <button id="logoutBtn" class="btn btn-ghost">登出</button>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto p-5 grid grid-cols-1 lg:grid-cols-12 gap-4">
    <!-- 左：控制台 -->
    <div class="lg:col-span-3">
      <div class="card p-4">
        <div class="card-inner">
          <div class="text-sm font-extrabold">控制台</div>

          <div class="mt-4">
            <div class="text-sm font-extrabold">Token 外掛</div>
            <div class="text-xs opacity-75 mt-1">URL(#token / ?token) → 本機儲存 → 手動貼上</div>

            <div class="mt-3">
              <label class="text-xs font-bold opacity-80">GitHub Token（只存在這台瀏覽器）</label>
              <input id="tokenInput" type="password" class="mt-1 w-full px-3 py-2 rounded-2xl text-sm"
                     placeholder="貼上 ghp_... 或 github_pat_...">
              <div class="mt-2 grid grid-cols-2 gap-2">
                <button id="saveTokenBtn" class="btn btn-primary">儲存 Token</button>
                <button id="clearTokenBtn" class="btn btn-ghost">清除 Token</button>
              </div>
              <div id="tokenMsg" class="mt-2 text-xs opacity-80"></div>
            </div>
          </div>

          <div class="h-px bg-white/5 my-4"></div>

          <div class="text-sm font-extrabold">版本資訊</div>
          <div id="metaText" class="text-xs opacity-80 mt-1">尚未讀取</div>

          <div class="mt-3 grid grid-cols-2 gap-2">
            <button id="reloadBtn" class="btn btn-ghost">重新讀取</button>
            <button id="saveBtn" class="btn btn-primary">儲存到雲端</button>
          </div>

          <div class="mt-2 grid grid-cols-2 gap-2">
            <button id="devToProdBtn" class="btn btn-ghost">開發中 → 上線</button>
            <button id="prodToOldBtn" class="btn btn-ghost">上線 → 舊檔備份</button>
          </div>

          <div class="mt-4">
            <label class="text-xs font-bold opacity-80">專案名稱</label>
            <input id="projectName" class="mt-1 w-full px-3 py-2 rounded-2xl text-sm" placeholder="例如：LINE 工具 Worker">
          </div>

          <div id="msg" class="hidden"></div>
        </div>
      </div>
    </div>

    <!-- 中：模組清單 -->
    <div class="lg:col-span-4">
      <div class="card p-4">
        <div class="card-inner">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-extrabold">模組清單</div>
              <div class="text-xs opacity-80 mt-1">拖曳「≡」可排序（排序會影響組裝順序）</div>
            </div>
            <button id="addModuleBtn" class="btn btn-ghost">＋ 新增模組</button>
          </div>

          <div id="moduleList" class="mt-3 space-y-2"></div>
        </div>
      </div>
    </div>

    <!-- 右：編輯 + 輸出 -->
    <div class="lg:col-span-5">
      <div class="card p-4">
        <div class="card-inner">
          <div class="flex items-start justify-between gap-2 flex-wrap">
            <div>
              <div class="text-sm font-extrabold">模組編輯</div>
              <div class="text-xs opacity-80 mt-1">正在編輯：<span id="editingName" class="font-bold">（未選）</span></div>
            </div>
            <div class="flex gap-2">
              <button id="templateBtn" class="btn btn-ghost">插入範本</button>
              <button id="formatBtn" class="btn btn-ghost">簡易整理</button>
            </div>
          </div>

          <textarea id="editor" class="mt-3 w-full h-[280px] px-3 py-3 rounded-2xl text-sm"
            placeholder="點左邊模組名稱開始編輯"></textarea>

          <div class="h-px bg-white/5 my-4"></div>

          <div class="flex items-center justify-between gap-2 flex-wrap">
            <div>
              <div class="text-sm font-extrabold">輸出：worker.js</div>
              <div class="text-xs opacity-80 mt-1">按組裝 → 複製 → 貼到 Cloudflare Worker</div>
            </div>
            <div class="flex gap-2">
              <button id="buildBtn" class="btn btn-primary">組裝</button>
              <button id="copyBtn" class="btn btn-ghost">複製</button>
              <button id="downloadBtn" class="btn btn-ghost">下載</button>
            </div>
          </div>

          <textarea id="output" class="mt-3 w-full h-[270px] px-3 py-3 rounded-2xl text-sm mono"
            placeholder="// 按「組裝」產生完整 worker.js"></textarea>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/** =========== 工具 / UI =========== */
const $ = (id) => document.getElementById(id);
function nowISO(){ return new Date().toISOString(); }
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

/** ✅ Toast：狀態顯示幾秒後消失 */
let toastTimer = 0;
function toast(text, ok=true, sub=""){
  const wrap = $("toastWrap");
  const el = document.createElement("div");
  el.className = "toast " + (ok ? "ok" : "err");
  el.innerHTML = `
    <div class="dot"></div>
    <div class="min-w-0">
      <div class="t">${escapeHtml(text)}</div>
      ${sub ? `<div class="s">${escapeHtml(sub)}</div>` : ``}
    </div>
  `;
  wrap.appendChild(el);
  while (wrap.children.length > 3) wrap.removeChild(wrap.firstChild);

  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => {
    el.classList.add("hide");
    setTimeout(()=> el.remove(), 260);
  }, 2600);
}
function setMsg(text, ok=true){ toast(text, ok); }
function tokenMsg(text, ok=true){
  $("tokenMsg").className = "mt-2 text-xs " + (ok ? "text-emerald-200" : "text-rose-200");
  $("tokenMsg").textContent = text || "";
  if (text) toast(text, ok, "Token 外掛");
}

function slotBadge(slot){
  const badge = $("slotBadge");
  badge.className = "badge " + (slot==="prod" ? "badge-prod" : slot==="old" ? "badge-old" : "badge-dev");
  badge.textContent = slot.toUpperCase();
}
function chips(slot){
  $("slotDev").classList.toggle("chip-on", slot==="dev");
  $("slotProd").classList.toggle("chip-on", slot==="prod");
  $("slotOld").classList.toggle("chip-on", slot==="old");
}

/** =====================================================
 * ✅ 外掛 Token：URL / localStorage / 手動輸入
 * ===================================================== */
const TOKEN_STORE_KEY = "WB_GH_TOKEN";
let runtimeToken = "";

function cleanToken(input){
  return String(input||"").trim().replace(/\s+/g,"").replace(/[^\x20-\x7E]/g,"");
}
function getTokenFromUrl(){
  try{
    const hash = location.hash || "";
    if (hash.startsWith("#")) {
      const sp = new URLSearchParams(hash.slice(1));
      const t = sp.get("token");
      if (t) return cleanToken(t);
    }
  }catch{}
  try{
    const sp = new URLSearchParams(location.search || "");
    const t = sp.get("token");
    if (t) return cleanToken(t);
  }catch{}
  return "";
}
function getTokenFromStore(){
  try{ return cleanToken(localStorage.getItem(TOKEN_STORE_KEY) || ""); }
  catch{ return ""; }
}
function setTokenToStore(t){
  try{ localStorage.setItem(TOKEN_STORE_KEY, cleanToken(t)); return true; }
  catch{ return false; }
}
function clearTokenStore(){
  try{ localStorage.removeItem(TOKEN_STORE_KEY); return true; }
  catch{ return false; }
}
function resolveToken(){
  const u = getTokenFromUrl(); if (u) return u;
  const s = getTokenFromStore(); if (s) return s;
  return cleanToken(runtimeToken);
}
function setTokenPill(){
  const t = resolveToken();
  const pill = $("tokenStatePill");
  if (t){
    const tail = t.slice(-6);
    pill.className = "pill border-emerald-200/20 bg-emerald-400/10 text-emerald-200";
    pill.textContent = `Token：已載入（…${tail}）`;
  }else{
    pill.className = "pill";
    pill.textContent = "Token：未載入";
  }
}

/** =====================================================
 * ✅ 正確授權格式（fine-grained / classic）
 * ===================================================== */
function authHeaders(){
  const t = resolveToken();
  const h = { "Accept": "application/vnd.github+json", "X-GitHub-Api-Version": "2022-11-28" };
  if (!t) return h;
  h["Authorization"] = t.startsWith("github_pat_") ? `Bearer ${t}` : `token ${t}`;
  return h;
}
async function readGitHubError(res){
  let txt = "";
  try { txt = await res.text(); } catch {}
  try {
    const j = JSON.parse(txt);
    if (j?.message) return `GitHub API ${res.status}：${j.message}`;
  } catch {}
  return `GitHub API ${res.status}：${txt || res.statusText}`;
}

/** =========== Gist API =========== */
async function gistGet(){
  const res = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, { headers: authHeaders() });
  if (!res.ok) throw new Error(await readGitHubError(res));
  return await res.json();
}
async function gistReadFile(slot){
  const resHeaders = authHeaders();
  if (!resHeaders.Authorization){
    throw new Error("尚未載入 GitHub Token：請在左側貼上後儲存，或用網址帶 #token=...");
  }
  const gist = await gistGet();
  const filename = CONFIG.FILES[slot];
  const file = gist.files?.[filename];
  if (!file) throw new Error("Gist 找不到檔案：" + filename);
  return file.content || "{}";
}
async function gistWriteFile(slot, content){
  const resHeaders = authHeaders();
  if (!resHeaders.Authorization){
    throw new Error("尚未載入 GitHub Token：請先載入 token 才能寫入 gist");
  }
  const filename = CONFIG.FILES[slot];
  const res = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, {
    method: "PATCH",
    headers: { ...resHeaders, "Content-Type": "application/json" },
    body: JSON.stringify({ files: { [filename]: { content } } })
  });
  if (!res.ok) throw new Error(await readGitHubError(res));
  return await res.json();
}

/** =========== 狀態 =========== */
const DEFAULT_PROJECT = () => ({
  name: "我的 Worker",
  updatedAt: nowISO(),
  modules: [
    { id: crypto.randomUUID(), name: "00_共用工具", enabled: true, code:
`// 共用工具
function json(data, status=200, headers={}) {
  return new Response(JSON.stringify(data), {
    status,
    headers: { "content-type":"application/json; charset=utf-8", ...headers },
  });
}
function text(s, status=200, headers={}) {
  return new Response(String(s), {
    status,
    headers: { "content-type":"text/plain; charset=utf-8", ...headers },
  });
}
function notFound(){ return new Response("Not Found", { status: 404 }); }
`},
    { id: crypto.randomUUID(), name: "10_路由", enabled: true, code:
`// 路由（你只要一直加 if）
async function router(request, env, ctx) {
  const url = new URL(request.url);
  if (url.pathname === "/") return text("OK");
  return notFound();
}
`},
    { id: crypto.randomUUID(), name: "99_入口", enabled: true, code:
`export default {
  async fetch(request, env, ctx) {
    try { return await router(request, env, ctx); }
    catch (err) { return json({ error:"server_error", message:String(err?.message||err) }, 500); }
  }
};
`}
  ]
});

let slot = "dev";
let project = DEFAULT_PROJECT();
let editingId = null;

/** =========== 渲染 =========== */
function renderMeta(){
  $("projectName").value = project.name || "";
  $("metaText").textContent = `狀態：${slot.toUpperCase()} · 更新：${project.updatedAt || "—"} · 模組：${project.modules?.length || 0}`;
}
function renderModules(){
  const wrap = $("moduleList");
  wrap.innerHTML = "";

  project.modules.forEach((m) => {
    const row = document.createElement("div");
    row.className = "row flex items-start justify-between gap-2";
    row.draggable = true;
    row.dataset.id = m.id;

    row.innerHTML = `
      <div class="flex items-start gap-2 min-w-0 flex-1">
        <div class="handle font-black select-none mt-0.5" title="拖曳排序">≡</div>
        <div class="min-w-0 flex-1">
          <div class="flex items-center gap-2">
            <input type="checkbox" class="h-4 w-4" ${m.enabled ? "checked" : ""} data-act="toggle">
            <button class="text-left font-extrabold text-sm truncate hover:underline" data-act="edit">${escapeHtml(m.name)}</button>
          </div>
          <div class="text-[11px] opacity-80 mt-1 mono truncate">${m.enabled ? "啟用中" : "停用"} · ${m.id}</div>
        </div>
      </div>
      <div class="flex gap-1 flex-shrink-0">
        <button class="btn btn-ghost px-2 py-1" data-act="rename">改名</button>
        <button class="btn btn-ghost px-2 py-1" data-act="dup">複製</button>
        <button class="btn btn-ghost px-2 py-1" data-act="del">刪除</button>
      </div>
    `;

    row.querySelector('[data-act="toggle"]').addEventListener("change", (e)=>{
      m.enabled = e.target.checked;
      setMsg(`模組「${m.name}」已${m.enabled ? "啟用" : "停用"}`);
    });

    row.querySelectorAll("[data-act]").forEach(el => {
      el.addEventListener("click", () => onModuleAction(el.getAttribute("data-act"), m.id));
    });

    row.addEventListener("dragstart", (e) => { e.dataTransfer.setData("text/plain", m.id); row.style.opacity = ".55"; });
    row.addEventListener("dragend", () => row.style.opacity = "1");
    row.addEventListener("dragover", (e) => { e.preventDefault(); });
    row.addEventListener("drop", (e) => {
      e.preventDefault();
      const fromId = e.dataTransfer.getData("text/plain");
      const toId = m.id;
      if (!fromId || fromId === toId) return;

      const fromIndex = project.modules.findIndex(x=>x.id===fromId);
      const toIndex = project.modules.findIndex(x=>x.id===toId);
      const [moved] = project.modules.splice(fromIndex, 1);
      project.modules.splice(toIndex, 0, moved);

      renderModules();
      setMsg("✅ 已重新排序（組裝順序已更新）", true);
    });

    wrap.appendChild(row);
  });
}

function onModuleAction(act, id){
  const i = project.modules.findIndex(x=>x.id===id);
  if (i<0) return;
  const m = project.modules[i];

  if (act === "edit"){
    editingId = id;
    $("editingName").textContent = m.name;
    $("editor").value = m.code || "";
    return;
  }
  if (act === "rename"){
    const nn = prompt("新模組名稱（建議用 00_,10_ 排序）", m.name);
    if (!nn) return;
    m.name = nn.trim();
    if (editingId === id) $("editingName").textContent = m.name;
    renderModules(); return;
  }
  if (act === "dup"){
    const copy = structuredClone(m);
    copy.id = crypto.randomUUID();
    copy.name = m.name + "_複製";
    project.modules.splice(i+1, 0, copy);
    renderModules();
    setMsg("已複製模組", true);
    return;
  }
  if (act === "del"){
    if (!confirm(`刪除模組「${m.name}」？`)) return;
    project.modules.splice(i,1);
    if (editingId === id){
      editingId = null;
      $("editingName").textContent = "（未選）";
      $("editor").value = "";
    }
    renderModules();
    setMsg("已刪除模組", true);
    return;
  }
}

/** =========== 組裝 =========== */
function buildWorker(){
  project.name = $("projectName").value.trim() || project.name;
  project.updatedAt = nowISO();

  const header =
`/**
 * Built by GavinTeam Worker 組裝後台
 * 狀態：${slot.toUpperCase()}
 * 更新時間：${project.updatedAt}
 * 啟用模組：${project.modules.filter(m=>m.enabled).map(m=>m.name).join("、")}
 */`;

  const body = project.modules
    .filter(m=>m.enabled)
    .map(m=>`\n\n// ===== 模組：${m.name} =====\n${m.code || ""}\n`)
    .join("");

  return `${header}\n${body}\n`;
}

/** =========== 雲端操作（依狀態） =========== */
async function loadSlot(){
  setTokenPill();
  const raw = await gistReadFile(slot);
  let obj;
  try { obj = JSON.parse(raw || "{}"); } catch { obj = {}; }
  if (!obj.modules) obj = DEFAULT_PROJECT();
  project = obj;

  editingId = null;
  $("editingName").textContent = "（未選）";
  $("editor").value = "";
  $("output").value = "";

  renderMeta();
  renderModules();
  setMsg(`✅ 已讀取：${CONFIG.FILES[slot]}（${slot.toUpperCase()}）`, true);
}
async function saveSlot(){
  setTokenPill();
  project.name = $("projectName").value.trim() || project.name;
  project.updatedAt = nowISO();
  await gistWriteFile(slot, JSON.stringify(project, null, 2));
  renderMeta();
  setMsg(`✅ 已儲存：${CONFIG.FILES[slot]}（${slot.toUpperCase()}）`, true);
}
async function copySlot(from, to){
  setTokenPill();
  const raw = await gistReadFile(from);
  await gistWriteFile(to, raw);
  setMsg(`✅ 已複製：${from.toUpperCase()} → ${to.toUpperCase()}`, true);
}
async function setSlot(next){
  slot = next;
  slotBadge(slot);
  chips(slot);
  renderMeta();
  try{ await loadSlot(); }
  catch(e){ setMsg(String(e.message || e), false); }
}

/** =========== 登入 =========== */
function showApp(){ $("loginScreen").classList.add("hidden"); $("app").classList.remove("hidden"); }
function showLogin(){ $("app").classList.add("hidden"); $("loginScreen").classList.remove("hidden"); }
function setLoginMsg(t){ $("loginMsg").textContent = t || ""; }

$("loginBtn").onclick = () => {
  const u = $("user").value.trim();
  const p = $("pass").value.trim();
  if (u === CONFIG.LOGIN_USER && p === CONFIG.LOGIN_PASS) {
    localStorage.setItem("WB_LOGIN_OK", "1");
    showApp();
    setSlot("dev");
    toast("登入成功", true, "HUD Online · DEV Loaded");
  } else {
    setLoginMsg("帳號或密碼錯誤");
    toast("登入失敗：帳號或密碼錯誤", false);
  }
};
$("logoutBtn").onclick = () => { localStorage.removeItem("WB_LOGIN_OK"); showLogin(); toast("已登出", true); };

/** =========== Token 外掛 =========== */
$("saveTokenBtn").onclick = async () => {
  const t = cleanToken($("tokenInput").value);
  if (!t) return tokenMsg("請先貼上 token", false);
  runtimeToken = t;
  const ok = setTokenToStore(t);
  setTokenPill();
  $("tokenInput").value = "";
  tokenMsg(ok ? "✅ Token 已儲存（同瀏覽器下次不用再貼）" : "✅ Token 已載入（但瀏覽器阻擋儲存）", true);

  try{ if (!$("app").classList.contains("hidden")) await loadSlot(); }
  catch(e){ setMsg(String(e.message||e), false); }
};
$("clearTokenBtn").onclick = () => { runtimeToken=""; clearTokenStore(); setTokenPill(); tokenMsg("已清除 Token", true); };

/** =========== 綁定 UI =========== */
$("slotDev").onclick  = async () => await setSlot("dev");
$("slotProd").onclick = async () => await setSlot("prod");
$("slotOld").onclick  = async () => await setSlot("old");

$("reloadBtn").onclick = async () => { try{ await loadSlot(); }catch(e){ setMsg(String(e.message||e), false);} };
$("saveBtn").onclick = async () => { try{ await saveSlot(); }catch(e){ setMsg(String(e.message||e), false);} };
$("devToProdBtn").onclick = async () => { try{ await copySlot("dev","prod"); if (slot==="prod") await loadSlot(); }catch(e){ setMsg(String(e.message||e), false);} };
$("prodToOldBtn").onclick = async () => { try{ await copySlot("prod","old"); if (slot==="old") await loadSlot(); }catch(e){ setMsg(String(e.message||e), false);} };

$("addModuleBtn").onclick = () => {
  const name = prompt("模組名稱（建議 30_功能名稱）", "30_新功能");
  if (!name) return;
  project.modules.push({ id: crypto.randomUUID(), name: name.trim(), enabled: true, code: `// ${name.trim()}\n\n` });
  renderModules();
  setMsg("已新增模組", true);
};

$("editor").addEventListener("input", () => {
  if (!editingId) return;
  const m = project.modules.find(x=>x.id===editingId);
  if (m) m.code = $("editor").value;
});

$("templateBtn").onclick = () => {
  if (!editingId) return setMsg("請先點一個模組名稱進入編輯", false);
  const tpl =
`// 範本：新增 handler
// router() 內加入：
// if (url.pathname === "/api/example") return handleExample(request, env, ctx);

async function handleExample(request, env, ctx) {
  return json({ ok: true, from: "handleExample" });
}
`;
  $("editor").value = ($("editor").value || "") + "\n\n" + tpl;
  const m = project.modules.find(x=>x.id===editingId);
  if (m) m.code = $("editor").value;
  setMsg("已插入範本", true);
};

$("formatBtn").onclick = () => {
  if (!editingId) return setMsg("請先點一個模組名稱進入編輯", false);
  $("editor").value = $("editor").value.replace(/\t/g,"  ").replace(/\r\n/g,"\n");
  const m = project.modules.find(x=>x.id===editingId);
  if (m) m.code = $("editor").value;
  setMsg("已簡易整理格式", true);
};

$("buildBtn").onclick = () => { $("output").value = buildWorker(); renderMeta(); setMsg("✅ 組裝完成：可直接貼到 Cloudflare Worker", true); };
$("copyBtn").onclick = async () => {
  try{
    const v = $("output").value || "";
    if (!v.trim()) return setMsg("請先按組裝", false);
    await navigator.clipboard.writeText(v);
    setMsg("已複製輸出內容", true);
  }catch{ setMsg("複製失敗：請確認剪貼簿權限", false); }
};
$("downloadBtn").onclick = () => {
  const content = $("output").value || "";
  if (!content.trim()) return setMsg("請先按組裝", false);
  const blob = new Blob([content], { type: "text/javascript;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `worker_${slot}.js`;
  a.click();
  URL.revokeObjectURL(url);
  setMsg("已下載 worker.js", true);
};

/** =========== 初始化 =========== */
(function init(){
  slotBadge(slot);
  chips(slot);
  renderMeta();
  renderModules();
  setTokenPill();

  const urlT = getTokenFromUrl();
  if (urlT){
    runtimeToken = urlT;
    setTokenToStore(urlT);
    tokenMsg("✅ 已從網址載入 Token（並嘗試存到本機）", true);
    try{
      if (location.hash && location.hash.includes("token=")){
        history.replaceState(null, "", location.pathname + location.search);
      }
    }catch{}
  }else{
    const st = getTokenFromStore();
    if (st) tokenMsg("已載入本機儲存的 Token（同瀏覽器有效）", true);
  }

  const ok = localStorage.getItem("WB_LOGIN_OK") === "1";
  if (ok){ showApp(); setSlot("dev"); }
  else { showLogin(); }
})();
</script>

</body>
</html>

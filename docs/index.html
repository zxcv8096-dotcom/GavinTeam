<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Worker çµ„è£å¾Œå°ï½œGavinTeamï¼ˆDEV å¯ç·¨è¼¯ï½œPROD/OLD åªè®€æˆå“ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --bd:rgba(15,23,42,.10);
      --glass: rgba(255,255,255,.72);
      --glass2: rgba(255,255,255,.60);
      --shadow: 0 24px 70px rgba(2,6,23,.10);
      --shadow2: 0 10px 30px rgba(2,6,23,.07);
      --ring: 0 0 0 4px rgba(99,102,241,.18);
    }
    body{
      font-family:system-ui,"Microsoft JhengHei";
      color:var(--ink);
      background:
        radial-gradient(1000px 600px at 15% 10%, rgba(99,102,241,.20), transparent 55%),
        radial-gradient(900px 520px at 85% 15%, rgba(34,197,94,.15), transparent 55%),
        radial-gradient(900px 520px at 55% 90%, rgba(14,165,233,.14), transparent 60%),
        linear-gradient(135deg, #f8fafc, #eef2ff, #ecfeff);
      -webkit-text-size-adjust:100%;
    }
    textarea, .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .shadow-soft{box-shadow:var(--shadow2);}
    .card{
      background:var(--glass);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border:1px solid var(--bd);
      border-radius:26px;
      box-shadow:var(--shadow);
    }
    .card-inner{
      background:linear-gradient(180deg, rgba(255,255,255,.72), rgba(255,255,255,.58));
      border:1px solid rgba(255,255,255,.5);
      border-radius:22px;
    }
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:.5rem;
      border-radius:16px;padding:.62rem .95rem;font-weight:900;font-size:12px;user-select:none;
      transition: transform .08s ease, filter .2s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; }
    .btn-primary{
      color:#fff;
      background: linear-gradient(135deg, #0f172a, #111827, #0b1220);
      box-shadow: 0 12px 22px rgba(2,6,23,.18);
    }
    .btn-primary:hover{ filter: brightness(1.06); }
    .btn-ghost{
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.75);
    }
    .btn-ghost:hover{ background: rgba(255,255,255,.92); }
    .chip{
      border:1px solid rgba(15,23,42,.12);
      border-radius:999px;padding:.35rem .7rem;font-size:12px;font-weight:900;
      background: rgba(255,255,255,.70);
      transition: all .2s ease;
    }
    .chip:hover{ background: rgba(255,255,255,.92); }
    .chip-on{
      background: linear-gradient(135deg, rgba(15,23,42,1), rgba(17,24,39,1));
      color:#fff;border-color: rgba(15,23,42,1);
      box-shadow: 0 10px 20px rgba(2,6,23,.18);
    }
    .badge{border-radius:999px;padding:.2rem .55rem;font-size:11px;font-weight:900}
    .badge-dev{background:#e0f2fe;color:#075985}
    .badge-prod{background:#dcfce7;color:#166534}
    .badge-old{background:#fef3c7;color:#92400e}
    .row{
      border:1px solid rgba(15,23,42,.10);
      border-radius:18px;padding:10px;
      background: rgba(255,255,255,.55);
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
    }
    .row:hover{ background: rgba(255,255,255,.86); transform: translateY(-1px); }
    .handle{cursor:grab}
    .handle:active{cursor:grabbing}
    .pill{
      border:1px solid rgba(15,23,42,.12);
      border-radius:999px;padding:.25rem .65rem;font-size:11px;font-weight:900;
      background: rgba(255,255,255,.65);
    }
    input:focus, textarea:focus{
      outline:none;
      box-shadow: var(--ring);
      border-color: rgba(99,102,241,.55) !important;
    }

    /* Toast */
    .toast-wrap{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    .toast{
      pointer-events: none;
      min-width: 280px;
      max-width: 420px;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.5);
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 18px 50px rgba(2,6,23,.14);
      display:flex;align-items:flex-start;gap:10px;
      transform: translateY(10px);
      opacity: 0;
      animation: toastIn .22s ease forwards;
    }
    .toast.hide{ animation: toastOut .22s ease forwards; }
    .toast .dot{
      margin-top: 4px;
      width:10px;height:10px;border-radius:999px;
      box-shadow: 0 0 0 5px rgba(16,185,129,.12);
      flex: 0 0 auto;
    }
    .toast.ok .dot{ background:#10b981; box-shadow: 0 0 0 5px rgba(16,185,129,.12); }
    .toast.err .dot{ background:#ef4444; box-shadow: 0 0 0 5px rgba(239,68,68,.12); }
    .toast .t{
      font-weight: 900;
      font-size: 12px;
      color: #0f172a;
      line-height: 1.35;
      word-break: break-word;
    }
    .toast .s{
      margin-top:2px;
      font-size: 11px;
      color: rgba(100,116,139,1);
    }
    @keyframes toastIn{ from{ opacity:0; transform: translateY(12px); } to{ opacity:1; transform: translateY(0); } }
    @keyframes toastOut{ from{ opacity:1; transform: translateY(0); } to{ opacity:0; transform: translateY(10px); } }

    .top-glow{
      position: fixed;
      inset: -200px -200px auto -200px;
      height: 360px;
      background:
        radial-gradient(closest-side at 20% 60%, rgba(99,102,241,.24), transparent 65%),
        radial-gradient(closest-side at 70% 40%, rgba(14,165,233,.18), transparent 65%),
        radial-gradient(closest-side at 90% 70%, rgba(34,197,94,.14), transparent 65%);
      filter: blur(10px);
      pointer-events:none;
      z-index: 0;
    }
  </style>
</head>

<body class="min-h-screen">
<div class="top-glow"></div>

<script>
/** =========================
 * âœ… ä½ åªè¦æ”¹é€™è£¡
 * ========================= */
const CONFIG = {
  // ä½ çš„ Gist IDï¼ˆç¶²å€æœ€å¾Œé‚£æ®µï¼‰
  GIST_ID: "17db93f6b4d4813bcbcfc66cc4ba343f",

  // ç™»å…¥å¸³å¯†ï¼ˆç´”å‰ç«¯ï¼‰
  LOGIN_USER: "gavin",
  LOGIN_PASS: "1234",

  // âœ… æª”åè¦å‰‡ï¼ˆå¾ˆé‡è¦ï¼‰
  // DEVï¼šç”¨ JSONï¼ˆå¯ç·¨è¼¯æ¨¡çµ„ï¼‰
  // PROD/OLDï¼šç”¨ JSï¼ˆåªè®€æˆå“ï¼‰
  FILES: {
    dev_json: "worker_dev.json",
    prod_js: "worker_prod.js",
    old_js:  "worker_old.js"
  }
};
</script>

<div id="toastWrap" class="toast-wrap"></div>

<!-- ===== ç™»å…¥ç•«é¢ ===== -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center p-6 relative z-10">
  <div class="w-full max-w-md card p-6">
    <div class="card-inner p-4">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-slate-900 text-white flex items-center justify-center font-black shadow-soft">G</div>
        <div class="min-w-0">
          <div class="text-lg font-extrabold text-slate-900">Worker çµ„è£å¾Œå°</div>
          <div class="text-xs text-slate-500 mt-0.5">DEV å¯ç·¨è¼¯ï½œPROD/OLD åªè®€æˆå“ï¼ˆä¸æœƒæ··åœ¨ä¸€èµ·ï¼‰</div>
        </div>
      </div>

      <div class="mt-5 space-y-3">
        <div>
          <label class="text-xs font-bold text-slate-600">å¸³è™Ÿ</label>
          <input id="user" class="mt-1 w-full px-3 py-2 border rounded-2xl text-sm bg-white/70" placeholder="è¼¸å…¥å¸³è™Ÿ">
        </div>
        <div>
          <label class="text-xs font-bold text-slate-600">å¯†ç¢¼</label>
          <input id="pass" type="password" class="mt-1 w-full px-3 py-2 border rounded-2xl text-sm bg-white/70" placeholder="è¼¸å…¥å¯†ç¢¼">
        </div>

        <button id="loginBtn" class="btn btn-primary w-full">ç™»å…¥</button>
        <div id="loginMsg" class="text-xs text-red-700"></div>
      </div>

      <div class="mt-5 text-[11px] text-slate-500 leading-5">
        DEVï¼šä½ æ­£åœ¨é–‹ç™¼ã€å¯æ”¹æ¨¡çµ„<br/>
        PRODï¼šçœŸæ­£ä¸Šç·šæˆå“ worker.js<br/>
        OLDï¼šä¸Šç·šå‰è‡ªå‹•å‚™ä»½ï¼ˆé˜²æ­¢é–‹ç™¼åšå£ï¼‰
      </div>
    </div>
  </div>
</div>

<!-- ===== ä¸»ç•«é¢ ===== -->
<div id="app" class="hidden relative z-10">
  <!-- Top bar -->
  <div class="sticky top-0 z-20 bg-white/35 backdrop-blur border-b border-white/40">
    <div class="max-w-7xl mx-auto px-5 py-4 flex items-center justify-between gap-3">
      <div class="min-w-0">
        <div class="flex items-center gap-2 flex-wrap">
          <div class="text-xl font-extrabold text-slate-900">Worker çµ„è£å¾Œå°</div>
          <span id="slotBadge" class="badge badge-dev">DEV</span>
          <span id="tokenStatePill" class="pill">Tokenï¼šæœªè¼‰å…¥</span>
          <span id="modePill" class="pill">æ¨¡å¼ï¼šDEV å¯ç·¨è¼¯</span>
        </div>
        <div class="text-xs text-slate-600 mt-1">
          âœ… DEVï¼šå¯ç·¨è¼¯æ¨¡çµ„ä¸¦ã€Œç™¼å¸ƒåˆ°ä¸Šç·šã€ï½œâœ… PROD/OLDï¼šåªè®€æˆå“ï¼ˆä¸æœƒå‡ºç¾ DEV å…§å®¹ï¼‰
        </div>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <button id="slotDev"  class="chip chip-on">é–‹ç™¼ä¸­</button>
        <button id="slotProd" class="chip">å·²ä¸Šç·š</button>
        <button id="slotOld"  class="chip">èˆŠæª”</button>
        <button id="logoutBtn" class="btn btn-ghost">ç™»å‡º</button>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto p-5 grid grid-cols-1 lg:grid-cols-12 gap-4">
    <!-- å·¦ï¼šæ§åˆ¶å°ï¼ˆåªåœ¨ DEV é¡¯ç¤ºï¼‰ -->
    <div class="lg:col-span-3" id="panelLeft">
      <div class="card p-4">
        <div class="card-inner p-4">
          <div class="text-sm font-extrabold text-slate-900">æ§åˆ¶å°ï¼ˆDEV æ‰æœƒå‡ºç¾ï¼‰</div>

          <!-- Token å¤–æ› -->
          <div class="mt-3">
            <div class="text-sm font-extrabold text-slate-900">Token å¤–æ›</div>
            <div class="text-xs text-slate-500 mt-1">å–ç”¨é †åºï¼šURL(#token / ?token) â†’ æœ¬æ©Ÿå„²å­˜ â†’ æ‰‹å‹•è²¼ä¸Š</div>

            <div class="mt-3">
              <label class="text-xs font-bold text-slate-600">GitHub Tokenï¼ˆåªå­˜åœ¨é€™å°ç€è¦½å™¨ï¼‰</label>
              <input id="tokenInput" type="password" class="mt-1 w-full px-3 py-2 border rounded-2xl text-sm bg-white/70"
                     placeholder="è²¼ä¸Š ghp_... æˆ– github_pat_...">
              <div class="mt-2 grid grid-cols-2 gap-2">
                <button id="saveTokenBtn" class="btn btn-primary">å„²å­˜ Token</button>
                <button id="clearTokenBtn" class="btn btn-ghost">æ¸…é™¤ Token</button>
              </div>
              <div id="tokenMsg" class="mt-2 text-xs text-slate-500"></div>
            </div>
          </div>

          <div class="h-px bg-white/50 my-4"></div>

          <div class="text-sm font-extrabold text-slate-900">ç‰ˆæœ¬è³‡è¨Š</div>
          <div id="metaText" class="text-xs text-slate-600 mt-1">å°šæœªè®€å–</div>

          <div class="mt-3">
            <label class="text-xs font-bold text-slate-600">å°ˆæ¡ˆåç¨±</label>
            <input id="projectName" class="mt-1 w-full px-3 py-2 border rounded-2xl text-sm bg-white/70" placeholder="ä¾‹å¦‚ï¼šLINE å·¥å…· Worker">
          </div>

          <div class="mt-3 grid grid-cols-2 gap-2">
            <button id="reloadBtn" class="btn btn-ghost">é‡æ–°è®€å– DEV</button>
            <button id="saveBtn" class="btn btn-primary">å„²å­˜ DEV</button>
          </div>

          <div class="mt-2 grid grid-cols-1 gap-2">
            <button id="publishBtn" class="btn btn-primary">ğŸš€ ç™¼å¸ƒåˆ°ä¸Šç·šï¼ˆPRODï¼‰</button>
            <div class="text-[11px] text-slate-500 leading-5">
              ç™¼å¸ƒæµç¨‹ï¼š<br/>
              â‘  è‡ªå‹•æŠŠç›®å‰ PROD å‚™ä»½åˆ° OLD<br/>
              â‘¡ ç”¨ DEV çµ„è£æˆå“ worker.js â†’ å¯«å…¥ PROD
            </div>
          </div>

          <div id="msg" class="hidden"></div>
        </div>
      </div>
    </div>

    <!-- ä¸­ï¼šæ¨¡çµ„æ¸…å–®ï¼ˆåªåœ¨ DEV é¡¯ç¤ºï¼‰ -->
    <div class="lg:col-span-4" id="panelMiddle">
      <div class="card p-4">
        <div class="card-inner p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-extrabold text-slate-900">æ¨¡çµ„æ¸…å–®ï¼ˆDEV æ‰æœƒå‡ºç¾ï¼‰</div>
              <div class="text-xs text-slate-600 mt-1">æ‹–æ›³ã€Œâ‰¡ã€å¯æ’åºï¼ˆæ’åºæœƒå½±éŸ¿çµ„è£é †åºï¼‰</div>
            </div>
            <button id="addModuleBtn" class="btn btn-ghost">ï¼‹ æ–°å¢æ¨¡çµ„</button>
          </div>

          <div id="moduleList" class="mt-3 space-y-2"></div>
        </div>
      </div>
    </div>

    <!-- å³ï¼šç·¨è¼¯ + è¼¸å‡ºï¼ˆPROD/OLD ä¹Ÿæœƒç•™è‘—ã€Œè¼¸å‡ºã€å€ï¼‰ -->
    <div class="lg:col-span-5">
      <div class="card p-4">
        <div class="card-inner p-4">
          <div class="flex items-start justify-between gap-2 flex-wrap">
            <div>
              <div class="text-sm font-extrabold text-slate-900">æ¨¡çµ„ç·¨è¼¯ï¼ˆåªæœ‰ DEV èƒ½ç”¨ï¼‰</div>
              <div class="text-xs text-slate-600 mt-1">æ­£åœ¨ç·¨è¼¯ï¼š<span id="editingName" class="font-bold text-slate-800">ï¼ˆæœªé¸ï¼‰</span></div>
            </div>
            <div class="flex gap-2">
              <button id="templateBtn" class="btn btn-ghost">æ’å…¥ç¯„æœ¬</button>
              <button id="formatBtn" class="btn btn-ghost">ç°¡æ˜“æ•´ç†</button>
            </div>
          </div>

          <textarea id="editor" class="mt-3 w-full h-[280px] px-3 py-3 border rounded-2xl text-sm bg-white/70"
            placeholder="é»å·¦é‚Šæ¨¡çµ„åç¨±é–‹å§‹ç·¨è¼¯"></textarea>

          <div class="h-px bg-white/50 my-4"></div>

          <div class="flex items-center justify-between gap-2 flex-wrap">
            <div>
              <div class="text-sm font-extrabold text-slate-900">è¼¸å‡ºï¼šworker.jsï¼ˆPROD/OLD åªè®€æˆå“ï¼‰</div>
              <div class="text-xs text-slate-600 mt-1" id="outputHint">DEVï¼šæŒ‰çµ„è£ â†’ è¤‡è£½ â†’ è²¼ Cloudflare Worker</div>
            </div>
            <div class="flex gap-2">
              <button id="buildBtn" class="btn btn-primary">çµ„è£</button>
              <button id="copyBtn" class="btn btn-ghost">è¤‡è£½</button>
              <button id="downloadBtn" class="btn btn-ghost">ä¸‹è¼‰</button>
            </div>
          </div>

          <textarea id="output" class="mt-3 w-full h-[270px] px-3 py-3 border rounded-2xl text-sm mono bg-white/70"
            placeholder="// DEVï¼šæŒ‰ã€Œçµ„è£ã€ç”¢ç”Ÿå®Œæ•´ worker.js\n// PROD/OLDï¼šé€™è£¡åªæœƒé¡¯ç¤ºæˆå“ worker.jsï¼ˆåªè®€ï¼‰"></textarea>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/** =========== å·¥å…· / UI =========== */
const $ = (id) => document.getElementById(id);
function nowISO(){ return new Date().toISOString(); }
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

/** Toast */
let toastTimer = 0;
function toast(text, ok=true, sub=""){
  const wrap = $("toastWrap");
  const el = document.createElement("div");
  el.className = "toast " + (ok ? "ok" : "err");
  el.innerHTML = `
    <div class="dot"></div>
    <div class="min-w-0">
      <div class="t">${escapeHtml(text)}</div>
      ${sub ? `<div class="s">${escapeHtml(sub)}</div>` : ``}
    </div>
  `;
  wrap.appendChild(el);
  while (wrap.children.length > 3) wrap.removeChild(wrap.firstChild);
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => {
    el.classList.add("hide");
    setTimeout(()=> el.remove(), 260);
  }, 2600);
}
function setMsg(text, ok=true){ toast(text, ok); }
function tokenMsg(text, ok=true){
  $("tokenMsg").className = "mt-2 text-xs " + (ok ? "text-emerald-700" : "text-red-700");
  $("tokenMsg").textContent = text || "";
  if (text) toast(text, ok, "Token å¤–æ›");
}

function slotBadge(slot){
  const badge = $("slotBadge");
  badge.className = "badge " + (slot==="prod" ? "badge-prod" : slot==="old" ? "badge-old" : "badge-dev");
  badge.textContent = slot.toUpperCase();
}
function chips(slot){
  $("slotDev").classList.toggle("chip-on", slot==="dev");
  $("slotProd").classList.toggle("chip-on", slot==="prod");
  $("slotOld").classList.toggle("chip-on", slot==="old");
}

/** =====================================================
 * âœ… å¤–æ› Tokenï¼šURL / localStorage / æ‰‹å‹•è¼¸å…¥
 * ===================================================== */
const TOKEN_STORE_KEY = "WB_GH_TOKEN";
let runtimeToken = "";

function cleanToken(input){
  return String(input||"")
    .trim()
    .replace(/\s+/g,"")
    .replace(/[^\x20-\x7E]/g,"");
}
function getTokenFromUrl(){
  try{
    const hash = location.hash || "";
    if (hash.startsWith("#")) {
      const h = hash.slice(1);
      const sp = new URLSearchParams(h);
      const t = sp.get("token");
      if (t) return cleanToken(t);
    }
  }catch{}
  try{
    const sp = new URLSearchParams(location.search || "");
    const t = sp.get("token");
    if (t) return cleanToken(t);
  }catch{}
  return "";
}
function getTokenFromStore(){
  try{ return cleanToken(localStorage.getItem(TOKEN_STORE_KEY) || ""); }
  catch{ return ""; }
}
function setTokenToStore(t){
  try{ localStorage.setItem(TOKEN_STORE_KEY, cleanToken(t)); return true; }
  catch{ return false; }
}
function clearTokenStore(){
  try{ localStorage.removeItem(TOKEN_STORE_KEY); return true; }
  catch{ return false; }
}
function resolveToken(){
  const u = getTokenFromUrl(); if (u) return u;
  const s = getTokenFromStore(); if (s) return s;
  return cleanToken(runtimeToken);
}
function setTokenPill(){
  const t = resolveToken();
  const pill = $("tokenStatePill");
  if (t){
    const tail = t.slice(-6);
    pill.className = "pill bg-emerald-50 text-emerald-700 border-emerald-200";
    pill.textContent = `Tokenï¼šå·²è¼‰å…¥ï¼ˆâ€¦${tail}ï¼‰`;
  }else{
    pill.className = "pill";
    pill.textContent = "Tokenï¼šæœªè¼‰å…¥";
  }
}
function authHeaders(){
  const t = resolveToken();
  const h = {
    "Accept": "application/vnd.github+json",
    "X-GitHub-Api-Version": "2022-11-28"
  };
  if (!t) return h;
  h["Authorization"] = t.startsWith("github_pat_") ? `Bearer ${t}` : `token ${t}`;
  return h;
}
async function readGitHubError(res){
  let txt = "";
  try { txt = await res.text(); } catch {}
  try {
    const j = JSON.parse(txt);
    if (j?.message) return `GitHub API ${res.status}ï¼š${j.message}`;
  } catch {}
  return `GitHub API ${res.status}ï¼š${txt || res.statusText}`;
}

/** =========== Gist API =========== */
async function gistGet(){
  const res = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, { headers: authHeaders() });
  if (!res.ok) throw new Error(await readGitHubError(res));
  return await res.json();
}
async function gistReadFile(filename){
  const resHeaders = authHeaders();
  if (!resHeaders.Authorization){
    throw new Error("å°šæœªè¼‰å…¥ GitHub Tokenï¼šè«‹åœ¨å·¦å´è²¼ä¸Šå¾Œå„²å­˜ï¼Œæˆ–ç”¨ç¶²å€å¸¶ #token=...");
  }
  const gist = await gistGet();
  const file = gist.files?.[filename];
  if (!file) throw new Error("Gist æ‰¾ä¸åˆ°æª”æ¡ˆï¼š" + filename);
  return file.content || "";
}
async function gistWriteFile(filename, content){
  const resHeaders = authHeaders();
  if (!resHeaders.Authorization){
    throw new Error("å°šæœªè¼‰å…¥ GitHub Tokenï¼šè«‹å…ˆè¼‰å…¥ token æ‰èƒ½å¯«å…¥ gist");
  }
  const res = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, {
    method: "PATCH",
    headers: { ...resHeaders, "Content-Type": "application/json" },
    body: JSON.stringify({ files: { [filename]: { content } } })
  });
  if (!res.ok) throw new Error(await readGitHubError(res));
  return await res.json();
}

/** =========== ç‹€æ…‹ / DEV å°ˆæ¡ˆï¼ˆJSON æ¨¡çµ„ï¼‰ =========== */
const DEFAULT_PROJECT = () => ({
  name: "æˆ‘çš„ Worker",
  updatedAt: nowISO(),
  modules: [
    { id: crypto.randomUUID(), name: "00_å…±ç”¨å·¥å…·", enabled: true, code:
`// å…±ç”¨å·¥å…·
function json(data, status=200, headers={}) {
  return new Response(JSON.stringify(data), {
    status,
    headers: { "content-type":"application/json; charset=utf-8", ...headers },
  });
}
function text(s, status=200, headers={}) {
  return new Response(String(s), {
    status,
    headers: { "content-type":"text/plain; charset=utf-8", ...headers },
  });
}
function notFound(){ return new Response("Not Found", { status: 404 }); }
`},
    { id: crypto.randomUUID(), name: "10_è·¯ç”±", enabled: true, code:
`// è·¯ç”±ï¼ˆä½ åªè¦ä¸€ç›´åŠ  ifï¼‰
async function router(request, env, ctx) {
  const url = new URL(request.url);

  if (url.pathname === "/") return text("OK");

  // ç¯„ä¾‹ï¼š
  // if (url.pathname.startsWith("/api/quiz")) return handleQuiz(request, env, ctx);
  // if (url.pathname === "/webhook") return handleWebhook(request, env, ctx);

  return notFound();
}
`},
    { id: crypto.randomUUID(), name: "99_å…¥å£", enabled: true, code:
`export default {
  async fetch(request, env, ctx) {
    try { return await router(request, env, ctx); }
    catch (err) { return json({ error:"server_error", message:String(err?.message||err) }, 500); }
  }
};
`}
  ]
});

let slot = "dev";          // dev | prod | old
let project = DEFAULT_PROJECT();
let editingId = null;

/** =========== UIï¼šDEV / PROD/OLD æ¨¡å¼åˆ‡æ›ï¼ˆä½ è¦çš„è¦å‰‡ï¼‰ =========== */
function setDevModeUI(){
  $("panelLeft").classList.remove("hidden");
  $("panelMiddle").classList.remove("hidden");

  $("modePill").textContent = "æ¨¡å¼ï¼šDEV å¯ç·¨è¼¯";
  $("outputHint").textContent = "DEVï¼šæŒ‰çµ„è£ â†’ è¤‡è£½ â†’ è²¼ Cloudflare Worker";

  $("templateBtn").disabled = false;
  $("formatBtn").disabled = false;
  $("buildBtn").disabled = false;
  $("saveBtn").disabled = false;
  $("reloadBtn").disabled = false;
  $("addModuleBtn").disabled = false;
  $("publishBtn").disabled = false;

  $("editor").readOnly = false;
  $("editor").placeholder = "é»å·¦é‚Šæ¨¡çµ„åç¨±é–‹å§‹ç·¨è¼¯";
}
function setProdOldModeUI(which){
  $("panelLeft").classList.add("hidden");
  $("panelMiddle").classList.add("hidden");

  $("modePill").textContent = which === "prod" ? "æ¨¡å¼ï¼šPROD åªè®€æˆå“" : "æ¨¡å¼ï¼šOLD åªè®€å‚™ä»½";
  $("outputHint").textContent = which === "prod"
    ? "PRODï¼šé€™è£¡åªé¡¯ç¤ºä¸Šç·šæˆå“ worker.jsï¼ˆåªè®€ï¼‰"
    : "OLDï¼šé€™è£¡åªé¡¯ç¤ºå‚™ä»½ worker.jsï¼ˆåªè®€ï¼‰";

  // ç¦æ­¢ DEV ç·¨è¼¯å™¨æ®˜ç•™
  editingId = null;
  $("editingName").textContent = which === "prod" ? "ï¼ˆä¸Šç·šæˆå“ï¼‰" : "ï¼ˆèˆŠæª”å‚™ä»½ï¼‰";
  $("editor").value = "";
  $("editor").readOnly = true;
  $("editor").placeholder = "æˆå“æ¨¡å¼ï¼šä¸èƒ½åœ¨é€™è£¡ç·¨è¼¯ï¼ˆè«‹åˆ‡å› DEVï¼‰";

  // ç¦æ­¢ DEV åŠŸèƒ½æŒ‰éˆ•
  $("templateBtn").disabled = true;
  $("formatBtn").disabled = true;
  $("buildBtn").disabled = true;
  $("saveBtn").disabled = true;
  $("reloadBtn").disabled = true;
  $("addModuleBtn").disabled = true;
  $("publishBtn").disabled = true;
}

/** =========== æ¸²æŸ“ DEV =========== */
function renderMeta(){
  $("projectName").value = project.name || "";
  $("metaText").textContent = `ç‹€æ…‹ï¼šDEV Â· æ›´æ–°ï¼š${project.updatedAt || "â€”"} Â· æ¨¡çµ„ï¼š${project.modules?.length || 0}`;
}
function renderModules(){
  const wrap = $("moduleList");
  wrap.innerHTML = "";

  project.modules.forEach((m) => {
    const row = document.createElement("div");
    row.className = "row flex items-start justify-between gap-2";
    row.draggable = true;
    row.dataset.id = m.id;

    row.innerHTML = `
      <div class="flex items-start gap-2 min-w-0 flex-1">
        <div class="handle text-slate-400 font-black select-none mt-0.5" title="æ‹–æ›³æ’åº">â‰¡</div>
        <div class="min-w-0 flex-1">
          <div class="flex items-center gap-2">
            <input type="checkbox" class="h-4 w-4" ${m.enabled ? "checked" : ""} data-act="toggle">
            <button class="text-left font-extrabold text-sm text-slate-900 truncate hover:underline" data-act="edit">${escapeHtml(m.name)}</button>
          </div>
          <div class="text-[11px] text-slate-600 mt-1 mono truncate">${m.enabled ? "å•Ÿç”¨ä¸­" : "åœç”¨"} Â· ${m.id}</div>
        </div>
      </div>
      <div class="flex gap-1 flex-shrink-0">
        <button class="btn btn-ghost px-2 py-1" data-act="rename">æ”¹å</button>
        <button class="btn btn-ghost px-2 py-1" data-act="dup">è¤‡è£½</button>
        <button class="btn btn-ghost px-2 py-1" data-act="del">åˆªé™¤</button>
      </div>
    `;

    row.querySelector('[data-act="toggle"]').addEventListener("change", (e)=>{
      m.enabled = e.target.checked;
      setMsg(`æ¨¡çµ„ã€Œ${m.name}ã€å·²${m.enabled ? "å•Ÿç”¨" : "åœç”¨"}`, true);
    });

    row.querySelectorAll("[data-act]").forEach(el => {
      el.addEventListener("click", () => onModuleAction(el.getAttribute("data-act"), m.id));
    });

    row.addEventListener("dragstart", (e) => {
      e.dataTransfer.setData("text/plain", m.id);
      row.style.opacity = ".55";
    });
    row.addEventListener("dragend", () => row.style.opacity = "1");
    row.addEventListener("dragover", (e) => { e.preventDefault(); });
    row.addEventListener("drop", (e) => {
      e.preventDefault();
      const fromId = e.dataTransfer.getData("text/plain");
      const toId = m.id;
      if (!fromId || fromId === toId) return;

      const fromIndex = project.modules.findIndex(x=>x.id===fromId);
      const toIndex = project.modules.findIndex(x=>x.id===toId);
      const [moved] = project.modules.splice(fromIndex, 1);
      project.modules.splice(toIndex, 0, moved);

      renderModules();
      setMsg("âœ… å·²é‡æ–°æ’åºï¼ˆçµ„è£é †åºå·²æ›´æ–°ï¼‰", true);
    });

    wrap.appendChild(row);
  });
}
function onModuleAction(act, id){
  const i = project.modules.findIndex(x=>x.id===id);
  if (i<0) return;
  const m = project.modules[i];

  if (act === "edit"){
    editingId = id;
    $("editingName").textContent = m.name;
    $("editor").value = m.code || "";
    return;
  }
  if (act === "rename"){
    const nn = prompt("æ–°æ¨¡çµ„åç¨±ï¼ˆå»ºè­°ç”¨ 00_,10_ æ’åºï¼‰", m.name);
    if (!nn) return;
    m.name = nn.trim();
    if (editingId === id) $("editingName").textContent = m.name;
    renderModules(); return;
  }
  if (act === "dup"){
    const copy = structuredClone(m);
    copy.id = crypto.randomUUID();
    copy.name = m.name + "_è¤‡è£½";
    project.modules.splice(i+1, 0, copy);
    renderModules();
    setMsg("å·²è¤‡è£½æ¨¡çµ„", true);
    return;
  }
  if (act === "del"){
    if (!confirm(`åˆªé™¤æ¨¡çµ„ã€Œ${m.name}ã€ï¼Ÿ`)) return;
    project.modules.splice(i,1);
    if (editingId === id){
      editingId = null;
      $("editingName").textContent = "ï¼ˆæœªé¸ï¼‰";
      $("editor").value = "";
    }
    renderModules();
    setMsg("å·²åˆªé™¤æ¨¡çµ„", true);
    return;
  }
}

/** =========== DEV çµ„è£ =========== */
function buildWorkerFromDev(){
  project.name = $("projectName").value.trim() || project.name;
  project.updatedAt = nowISO();

  const header =
`/**
 * Built by GavinTeam Worker çµ„è£å¾Œå°
 * ä¾†æºï¼šDEVï¼ˆæ¨¡çµ„çµ„è£ï¼‰
 * æ›´æ–°æ™‚é–“ï¼š${project.updatedAt}
 * å•Ÿç”¨æ¨¡çµ„ï¼š${project.modules.filter(m=>m.enabled).map(m=>m.name).join("ã€")}
 */`;

  const body = project.modules
    .filter(m=>m.enabled)
    .map(m=>`\n\n// ===== æ¨¡çµ„ï¼š${m.name} =====\n${m.code || ""}\n`)
    .join("");

  return `${header}\n${body}\n`;
}

/** =========== è®€/å¯«ï¼šDEV JSONã€PROD/OLD JSï¼ˆæˆå“ï¼‰ =========== */
async function loadDevProject(){
  const raw = await gistReadFile(CONFIG.FILES.dev_json);
  let obj;
  try { obj = JSON.parse(raw || "{}"); } catch { obj = null; }
  if (!obj || !Array.isArray(obj.modules)) obj = DEFAULT_PROJECT();
  project = obj;

  editingId = null;
  $("editingName").textContent = "ï¼ˆæœªé¸ï¼‰";
  $("editor").value = "";
  $("output").value = "";

  renderMeta();
  renderModules();
  setMsg(`âœ… å·²è®€å– DEVï¼š${CONFIG.FILES.dev_json}`, true);
}
async function saveDevProject(){
  project.name = $("projectName").value.trim() || project.name;
  project.updatedAt = nowISO();
  await gistWriteFile(CONFIG.FILES.dev_json, JSON.stringify(project, null, 2));
  renderMeta();
  setMsg(`âœ… å·²å„²å­˜ DEVï¼š${CONFIG.FILES.dev_json}`, true);
}
async function loadArtifact(which){ // prod | old
  const filename = which === "prod" ? CONFIG.FILES.prod_js : CONFIG.FILES.old_js;
  const raw = await gistReadFile(filename);
  $("output").value = (raw || "").trim() ? raw : `// ${filename} ç›®å‰æ˜¯ç©ºçš„`;
  setMsg(`âœ… å·²è®€å– ${which.toUpperCase()} æˆå“ï¼š${filename}`, true);
}
async function writeArtifact(which, js){ // prod | old
  const filename = which === "prod" ? CONFIG.FILES.prod_js : CONFIG.FILES.old_js;
  await gistWriteFile(filename, js);
}

/** =========== ç™¼å¸ƒï¼šDEV â†’ï¼ˆå‚™ä»½ PROD åˆ° OLDï¼‰â†’ å¯«å…¥ PROD =========== */
async function publishDevToProd(){
  if (!confirm("ç¢ºå®šè¦ç™¼å¸ƒåˆ°ä¸Šç·šï¼ˆPRODï¼‰ï¼Ÿ\n\næœƒå…ˆå‚™ä»½ç›®å‰ PROD åˆ° OLDï¼Œå†æŠŠ DEV çµ„è£æˆå“å¯«å…¥ PRODã€‚")) return;

  // 1) å…ˆçµ„è£
  const built = buildWorkerFromDev();
  if (!built.trim()) throw new Error("DEV çµ„è£çµæœæ˜¯ç©ºçš„ï¼Œç„¡æ³•ç™¼å¸ƒ");

  // 2) è®€ç›®å‰ PROD â†’ å¯«å…¥ OLDï¼ˆå‚™ä»½ï¼‰
  let prodRaw = "";
  try { prodRaw = await gistReadFile(CONFIG.FILES.prod_js); } catch { prodRaw = ""; }
  await writeArtifact("old", prodRaw || `// å‚™ä»½æ™‚é–“ï¼š${nowISO()}\n// åŸæœ¬ PROD æ˜¯ç©ºçš„\n`);

  // 3) å¯«å…¥æ–° PROD
  await writeArtifact("prod", built);

  // 4) UI é¡¯ç¤ºä¸€ä¸‹
  $("output").value = built;
  setMsg("ğŸš€ ç™¼å¸ƒå®Œæˆï¼šå·²å‚™ä»½åˆ° OLDï¼Œä¸¦æ›´æ–° PROD æˆå“", true);
}

/** =========== åˆ‡æ›ç‹€æ…‹ï¼ˆæ ¸å¿ƒï¼šä¸è®“ DEV å…§å®¹å‡ºç¾åœ¨ PROD/OLDï¼‰ =========== */
async function setSlot(next){
  slot = next;
  slotBadge(slot);
  chips(slot);
  setTokenPill();

  try{
    if (slot === "dev"){
      setDevModeUI();
      await loadDevProject();
    }else{
      setProdOldModeUI(slot);
      await loadArtifact(slot);
    }
  }catch(e){
    setMsg(String(e.message || e), false);
  }
}

/** =========== ç™»å…¥ =========== */
function showApp(){
  $("loginScreen").classList.add("hidden");
  $("app").classList.remove("hidden");
}
function showLogin(){
  $("app").classList.add("hidden");
  $("loginScreen").classList.remove("hidden");
}
function setLoginMsg(t){ $("loginMsg").textContent = t || ""; }

/** =========== ç¶å®šäº‹ä»¶ =========== */
$("loginBtn").onclick = () => {
  const u = $("user").value.trim();
  const p = $("pass").value.trim();
  if (u === CONFIG.LOGIN_USER && p === CONFIG.LOGIN_PASS) {
    localStorage.setItem("WB_LOGIN_OK", "1");
    showApp();
    setSlot("dev");
    toast("ç™»å…¥æˆåŠŸ", true, "å·²åˆ‡åˆ° DEV ä¸¦è‡ªå‹•è®€å–");
  } else {
    setLoginMsg("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
    toast("ç™»å…¥å¤±æ•—ï¼šå¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤", false);
  }
};
$("logoutBtn").onclick = () => {
  localStorage.removeItem("WB_LOGIN_OK");
  showLogin();
  toast("å·²ç™»å‡º", true);
};

$("saveTokenBtn").onclick = async () => {
  const t = cleanToken($("tokenInput").value);
  if (!t) return tokenMsg("è«‹å…ˆè²¼ä¸Š token", false);

  runtimeToken = t;
  const ok = setTokenToStore(t);
  setTokenPill();
  $("tokenInput").value = "";
  tokenMsg(ok ? "âœ… Token å·²å„²å­˜ï¼ˆåŒç€è¦½å™¨ä¸‹æ¬¡ä¸ç”¨å†è²¼ï¼‰" : "âœ… Token å·²è¼‰å…¥ï¼ˆä½†ç€è¦½å™¨é˜»æ“‹å„²å­˜ï¼Œé‡é–‹éœ€å†è²¼ï¼‰", true);

  // é‡æ–°è¼‰å…¥ç•¶å‰æ§½ä½ï¼ˆé¿å…æ²’ token æ™‚è®€ä¸åˆ°ï¼‰
  try{ await setSlot(slot); }catch(e){ setMsg(String(e.message||e), false); }
};
$("clearTokenBtn").onclick = () => {
  runtimeToken = "";
  clearTokenStore();
  setTokenPill();
  tokenMsg("å·²æ¸…é™¤ Tokenï¼ˆæœ¬æ©Ÿå„²å­˜å·²ç§»é™¤ï¼‰", true);
};

$("slotDev").onclick  = async () => await setSlot("dev");
$("slotProd").onclick = async () => await setSlot("prod");
$("slotOld").onclick  = async () => await setSlot("old");

$("reloadBtn").onclick = async () => {
  try { await loadDevProject(); } catch(e){ setMsg(String(e.message||e), false); }
};
$("saveBtn").onclick = async () => {
  try { await saveDevProject(); } catch(e){ setMsg(String(e.message||e), false); }
};
$("publishBtn").onclick = async () => {
  try { await publishDevToProd(); } catch(e){ setMsg(String(e.message||e), false); }
};

$("addModuleBtn").onclick = () => {
  const name = prompt("æ¨¡çµ„åç¨±ï¼ˆå»ºè­° 30_åŠŸèƒ½åç¨±ï¼‰", "30_æ–°åŠŸèƒ½");
  if (!name) return;
  project.modules.push({ id: crypto.randomUUID(), name: name.trim(), enabled: true, code: `// ${name.trim()}\n\n` });
  renderModules();
  setMsg("å·²æ–°å¢æ¨¡çµ„", true);
};

$("editor").addEventListener("input", () => {
  if (!editingId) return;
  const m = project.modules.find(x=>x.id===editingId);
  if (m) m.code = $("editor").value;
});

$("templateBtn").onclick = () => {
  if (slot !== "dev") return setMsg("ç›®å‰ä¸æ˜¯ DEVï¼Œä¸èƒ½ç·¨è¼¯", false);
  if (!editingId) return setMsg("è«‹å…ˆé»ä¸€å€‹æ¨¡çµ„åç¨±é€²å…¥ç·¨è¼¯", false);
  const tpl =
`// ç¯„æœ¬ï¼šæ–°å¢ handler
// router() å…§åŠ å…¥ï¼š
// if (url.pathname === "/api/example") return handleExample(request, env, ctx);

async function handleExample(request, env, ctx) {
  return json({ ok: true, from: "handleExample" });
}
`;
  $("editor").value = ($("editor").value || "") + "\n\n" + tpl;
  const m = project.modules.find(x=>x.id===editingId);
  if (m) m.code = $("editor").value;
  setMsg("å·²æ’å…¥ç¯„æœ¬", true);
};

$("formatBtn").onclick = () => {
  if (slot !== "dev") return setMsg("ç›®å‰ä¸æ˜¯ DEVï¼Œä¸èƒ½ç·¨è¼¯", false);
  if (!editingId) return setMsg("è«‹å…ˆé»ä¸€å€‹æ¨¡çµ„åç¨±é€²å…¥ç·¨è¼¯", false);
  $("editor").value = $("editor").value.replace(/\t/g,"  ").replace(/\r\n/g,"\n");
  const m = project.modules.find(x=>x.id===editingId);
  if (m) m.code = $("editor").value;
  setMsg("å·²ç°¡æ˜“æ•´ç†æ ¼å¼", true);
};

$("buildBtn").onclick = () => {
  if (slot !== "dev") return setMsg("ç›®å‰ä¸æ˜¯ DEVï¼Œä¸èƒ½çµ„è£", false);
  $("output").value = buildWorkerFromDev();
  renderMeta();
  setMsg("âœ… çµ„è£å®Œæˆï¼šå¯ç›´æ¥è²¼åˆ° Cloudflare Worker", true);
};

$("copyBtn").onclick = async () => {
  try{
    const v = $("output").value || "";
    if (!v.trim()) return setMsg("æ²’æœ‰å…§å®¹å¯è¤‡è£½", false);
    await navigator.clipboard.writeText(v);
    setMsg("å·²è¤‡è£½è¼¸å‡ºå…§å®¹", true);
  }catch{
    setMsg("è¤‡è£½å¤±æ•—ï¼šè«‹ç¢ºèªç€è¦½å™¨å‰ªè²¼ç°¿æ¬Šé™", false);
  }
};

$("downloadBtn").onclick = () => {
  const content = $("output").value || "";
  if (!content.trim()) return setMsg("æ²’æœ‰å…§å®¹å¯ä¸‹è¼‰", false);
  const blob = new Blob([content], { type: "text/javascript;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `worker_${slot}.js`;
  a.click();
  URL.revokeObjectURL(url);
  setMsg("å·²ä¸‹è¼‰ worker.js", true);
};

/** =========== åˆå§‹åŒ– =========== */
(function init(){
  slotBadge(slot);
  chips(slot);
  setTokenPill();

  // å¦‚æœç¶²å€æœ‰å¸¶ tokenï¼Œé †ä¾¿å­˜èµ·ä¾†ï¼ˆæ–¹ä¾¿ä¸‹æ¬¡ï¼‰
  const urlT = getTokenFromUrl();
  if (urlT){
    runtimeToken = urlT;
    setTokenToStore(urlT);
    tokenMsg("âœ… å·²å¾ç¶²å€è¼‰å…¥ Tokenï¼ˆä¸¦å˜—è©¦å­˜åˆ°æœ¬æ©Ÿï¼‰", true);
    try{
      if (location.hash && location.hash.includes("token=")){
        history.replaceState(null, "", location.pathname + location.search);
      }
    }catch{}
  }else{
    const st = getTokenFromStore();
    if (st) tokenMsg("å·²è¼‰å…¥æœ¬æ©Ÿå„²å­˜çš„ Tokenï¼ˆåŒç€è¦½å™¨æœ‰æ•ˆï¼‰", true);
  }

  const ok = localStorage.getItem("WB_LOGIN_OK") === "1";
  if (ok){
    showApp();
    setSlot("dev"); // é è¨­é€² DEV
  } else {
    showLogin();
  }
})();
</script>

</body>
</html>

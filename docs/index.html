<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Worker Builder｜GavinTeam</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:system-ui,"Microsoft JhengHei";}
    textarea, .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .shadow-soft{box-shadow:0 10px 30px rgba(2,6,23,.06);}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border-radius:14px;padding:.55rem .9rem;font-weight:900;font-size:12px;user-select:none}
    .btn-primary{background:#0f172a;color:#fff}
    .btn-primary:hover{background:#000}
    .btn-ghost{border:1px solid #e5e7eb;background:#fff}
    .btn-ghost:hover{background:#f8fafc}
    .chip{border:1px solid #e5e7eb;border-radius:999px;padding:.35rem .7rem;font-size:12px;font-weight:900}
    .chip-on{background:#0f172a;color:#fff;border-color:#0f172a}
    .badge{border-radius:999px;padding:.2rem .55rem;font-size:11px;font-weight:900}
    .badge-dev{background:#e0f2fe;color:#075985}
    .badge-prod{background:#dcfce7;color:#166534}
    .badge-old{background:#fef3c7;color:#92400e}
  </style>
</head>

<body class="min-h-screen bg-slate-50">
<script>
/** =========================
 *  ✅ 只要改這裡（3 個地方）
 *  ========================= */
const CONFIG = {
  // 1) 你的 Gist ID（網址最後那段）
  GIST_ID: "17db93f6b4d4813bcbcfc66cc4ba343f",

  // 2) 你的 GitHub Token（只要能讀寫 gist）
  GITHUB_TOKEN: "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",

  // 3) 登入帳密（純前端）
  LOGIN_USER: "gavin",
  LOGIN_PASS: "lily820620",

  // 檔名固定（不要改）
  FILES: {
    dev:  "worker_dev.json",
    prod: "worker_prod.json",
    old:  "worker_old.json",
  }
};
</script>

<!-- ===== Login Screen ===== -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-md bg-white border rounded-3xl p-6 shadow-soft">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-2xl bg-slate-900 text-white flex items-center justify-center font-black">G</div>
      <div>
        <div class="text-lg font-extrabold text-slate-900">Worker Builder</div>
        <div class="text-xs text-slate-500 mt-0.5">登入後編輯與組裝 worker.js</div>
      </div>
    </div>

    <div class="mt-6 space-y-3">
      <div>
        <label class="text-xs font-bold text-slate-600">帳號</label>
        <input id="user" class="mt-1 w-full px-3 py-2 border rounded-2xl text-sm" placeholder="輸入帳號">
      </div>
      <div>
        <label class="text-xs font-bold text-slate-600">密碼</label>
        <input id="pass" type="password" class="mt-1 w-full px-3 py-2 border rounded-2xl text-sm" placeholder="輸入密碼">
      </div>

      <button id="loginBtn" class="btn btn-primary w-full">登入</button>
      <div id="loginMsg" class="text-xs text-red-700"></div>
    </div>

    <div class="mt-6 text-[11px] text-slate-500">
      版本：DEV / PROD / OLD（雲端存檔於 GitHub Gist）
    </div>
  </div>
</div>

<!-- ===== App ===== -->
<div id="app" class="hidden">
  <!-- Top Bar -->
  <div class="sticky top-0 z-20 bg-slate-50/80 backdrop-blur border-b">
    <div class="max-w-7xl mx-auto px-5 py-4 flex items-center justify-between gap-3">
      <div class="min-w-0">
        <div class="flex items-center gap-2">
          <div class="text-xl font-extrabold text-slate-900">Worker Builder</div>
          <span id="slotBadge" class="badge badge-dev">DEV</span>
        </div>
        <div class="text-xs text-slate-500 mt-1">
          流程：<span class="font-bold text-slate-700">讀</span> → 改 → <span class="font-bold text-slate-700">存</span> → DEV→PROD → 組裝 → 貼 Cloudflare
        </div>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <button id="slotDev"  class="chip chip-on">開發中</button>
        <button id="slotProd" class="chip">已上線</button>
        <button id="slotOld"  class="chip">舊檔</button>
        <button id="logoutBtn" class="btn btn-ghost">登出</button>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="max-w-7xl mx-auto p-5 grid grid-cols-1 lg:grid-cols-12 gap-4">
    <!-- Left: Actions + Module List -->
    <div class="lg:col-span-4">
      <div class="bg-white border rounded-3xl p-4 shadow-soft">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm font-extrabold text-slate-900">版本</div>
            <div id="metaText" class="text-xs text-slate-500 mt-1">尚未讀取</div>
          </div>
          <div class="flex gap-2">
            <button id="loadBtn" class="btn btn-ghost">從雲端讀</button>
            <button id="saveBtn" class="btn btn-primary">存到雲端</button>
          </div>
        </div>

        <div class="mt-3 flex gap-2">
          <button id="devToProdBtn" class="btn btn-ghost flex-1">DEV → PROD</button>
          <button id="prodToOldBtn" class="btn btn-ghost flex-1">PROD → OLD</button>
        </div>

        <div class="mt-4">
          <label class="text-xs font-bold text-slate-600">專案名稱</label>
          <input id="projectName" class="mt-1 w-full px-3 py-2 border rounded-2xl text-sm" placeholder="例如：LINE 工具 Worker">
        </div>

        <div class="mt-4 flex items-center justify-between">
          <div class="text-sm font-extrabold text-slate-900">模組</div>
          <button id="addModuleBtn" class="btn btn-ghost">＋ 新增</button>
        </div>

        <div id="moduleList" class="mt-3 space-y-2"></div>

        <div id="msg" class="mt-3 text-xs"></div>
      </div>
    </div>

    <!-- Middle: Editor -->
    <div class="lg:col-span-4">
      <div class="bg-white border rounded-3xl p-4 shadow-soft h-full">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <div>
            <div class="text-sm font-extrabold text-slate-900">編輯</div>
            <div class="text-xs text-slate-500 mt-1">正在編輯：<span id="editingName" class="font-bold text-slate-700">（未選）</span></div>
          </div>
          <div class="flex gap-2">
            <button id="templateBtn" class="btn btn-ghost">插入範本</button>
            <button id="formatBtn" class="btn btn-ghost">簡易整理</button>
          </div>
        </div>

        <textarea id="editor" class="mt-3 w-full h-[560px] px-3 py-3 border rounded-2xl text-sm"
          placeholder="// 點左邊模組名稱開始編輯"></textarea>
      </div>
    </div>

    <!-- Right: Build / Output -->
    <div class="lg:col-span-4">
      <div class="bg-white border rounded-3xl p-4 shadow-soft h-full">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <div>
            <div class="text-sm font-extrabold text-slate-900">輸出</div>
            <div class="text-xs text-slate-500 mt-1">一鍵組裝成完整 worker.js</div>
          </div>
          <div class="flex gap-2">
            <button id="buildBtn" class="btn btn-primary">組裝</button>
            <button id="copyBtn" class="btn btn-ghost">複製</button>
            <button id="downloadBtn" class="btn btn-ghost">下載</button>
          </div>
        </div>

        <textarea id="output" class="mt-3 w-full h-[560px] px-3 py-3 border rounded-2xl text-sm mono"
          placeholder="// 按「組裝」產生完整 worker.js"></textarea>
      </div>
    </div>
  </div>
</div>

<script>
/** ===========
 * Utilities
 * =========== */
const $ = (id) => document.getElementById(id);

function setMsg(text, ok=true){
  $("msg").className = "mt-3 text-xs " + (ok ? "text-emerald-700" : "text-red-700");
  $("msg").textContent = text;
}

function slotBadge(slot){
  const badge = $("slotBadge");
  badge.className = "badge " + (slot==="prod" ? "badge-prod" : slot==="old" ? "badge-old" : "badge-dev");
  badge.textContent = slot.toUpperCase();
}

function chips(slot){
  $("slotDev").classList.toggle("chip-on", slot==="dev");
  $("slotProd").classList.toggle("chip-on", slot==="prod");
  $("slotOld").classList.toggle("chip-on", slot==="old");
}

function nowISO(){ return new Date().toISOString(); }

/** ===========
 * Gist API
 * =========== */
async function gistGet(gistId){
  const res = await fetch(`https://api.github.com/gists/${gistId}`, {
    headers: { "Authorization": `Bearer ${CONFIG.GITHUB_TOKEN}` }
  });
  if (!res.ok) throw new Error("讀取 Gist 失敗：" + res.status);
  return await res.json();
}

async function gistReadFile(slot){
  const gist = await gistGet(CONFIG.GIST_ID);
  const filename = CONFIG.FILES[slot];
  const file = gist.files?.[filename];
  if (!file) throw new Error("Gist 找不到檔案：" + filename);
  return file.content || "{}";
}

async function gistWriteFile(slot, content){
  const filename = CONFIG.FILES[slot];
  const res = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, {
    method: "PATCH",
    headers: {
      "Authorization": `Bearer ${CONFIG.GITHUB_TOKEN}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ files: { [filename]: { content } } })
  });
  if (!res.ok) throw new Error("寫入 Gist 失敗：" + res.status);
  return await res.json();
}

/** ===========
 * App State
 * =========== */
const DEFAULT_PROJECT = () => ({
  name: "My Worker",
  updatedAt: nowISO(),
  modules: [
    { id: crypto.randomUUID(), name: "00_bootstrap", enabled: true, code:
`// 共用工具
function json(data, status=200, headers={}) {
  return new Response(JSON.stringify(data), {
    status,
    headers: { "content-type":"application/json; charset=utf-8", ...headers },
  });
}
function text(s, status=200, headers={}) {
  return new Response(String(s), {
    status,
    headers: { "content-type":"text/plain; charset=utf-8", ...headers },
  });
}
function notFound(){ return new Response("Not Found", { status: 404 }); }
`},
    { id: crypto.randomUUID(), name: "10_routes", enabled: true, code:
`// 路由
async function router(request, env, ctx) {
  const url = new URL(request.url);

  if (url.pathname === "/") return text("OK");

  // if (url.pathname.startsWith("/api/quiz")) return handleQuiz(request, env, ctx);
  // if (url.pathname === "/webhook") return handleWebhook(request, env, ctx);

  return notFound();
}
`},
    { id: crypto.randomUUID(), name: "99_entry", enabled: true, code:
`export default {
  async fetch(request, env, ctx) {
    try { return await router(request, env, ctx); }
    catch (err) { return json({ error:"server_error", message:String(err?.message||err) }, 500); }
  }
};
`}
  ]
});

let slot = "dev";
let project = DEFAULT_PROJECT();
let editingId = null;

/** ===========
 * Render
 * =========== */
function renderMeta(){
  $("projectName").value = project.name || "";
  $("metaText").textContent = `Slot: ${slot.toUpperCase()} · Updated: ${project.updatedAt || "—"}`;
}

function renderModules(){
  const wrap = $("moduleList");
  wrap.innerHTML = "";

  project.modules.forEach((m, idx) => {
    const row = document.createElement("div");
    row.className = "border rounded-2xl p-3 flex items-start justify-between gap-2";

    row.innerHTML = `
      <div class="min-w-0 flex-1">
        <div class="flex items-center gap-2">
          <input type="checkbox" class="h-4 w-4 mt-0.5" ${m.enabled ? "checked" : ""} data-act="toggle">
          <button class="text-left font-extrabold text-sm text-slate-900 truncate hover:underline" data-act="edit">${escapeHtml(m.name)}</button>
        </div>
        <div class="text-[11px] text-slate-500 mt-1 mono truncate">${m.enabled ? "enabled" : "disabled"} · ${m.id}</div>
      </div>
      <div class="flex gap-1 flex-shrink-0">
        <button class="btn btn-ghost px-2 py-1" data-act="up">↑</button>
        <button class="btn btn-ghost px-2 py-1" data-act="down">↓</button>
        <button class="btn btn-ghost px-2 py-1" data-act="rename">✎</button>
        <button class="btn btn-ghost px-2 py-1" data-act="dup">⎘</button>
        <button class="btn btn-ghost px-2 py-1" data-act="del">×</button>
      </div>
    `;

    row.querySelectorAll("[data-act]").forEach(el => {
      el.addEventListener("click", (e) => {
        const act = el.getAttribute("data-act");
        onModuleAction(act, m.id);
      });
    });

    row.querySelector('[data-act="toggle"]').addEventListener("change", (e)=>{
      m.enabled = e.target.checked;
      setMsg(`模組「${m.name}」已${m.enabled ? "啟用" : "停用"}`);
    });

    wrap.appendChild(row);
  });
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

function onModuleAction(act, id){
  const i = project.modules.findIndex(x=>x.id===id);
  if (i<0) return;
  const m = project.modules[i];

  if (act === "edit"){
    editingId = id;
    $("editingName").textContent = m.name;
    $("editor").value = m.code || "";
    return;
  }
  if (act === "up" && i>0){
    [project.modules[i-1], project.modules[i]] = [project.modules[i], project.modules[i-1]];
    renderModules(); return;
  }
  if (act === "down" && i<project.modules.length-1){
    [project.modules[i+1], project.modules[i]] = [project.modules[i], project.modules[i+1]];
    renderModules(); return;
  }
  if (act === "rename"){
    const nn = prompt("新模組名稱（建議 00_,10_ 排序）", m.name);
    if (!nn) return;
    m.name = nn.trim();
    if (editingId === id) $("editingName").textContent = m.name;
    renderModules(); return;
  }
  if (act === "dup"){
    const copy = structuredClone(m);
    copy.id = crypto.randomUUID();
    copy.name = m.name + "_copy";
    project.modules.push(copy);
    renderModules(); return;
  }
  if (act === "del"){
    if (!confirm(`刪除模組「${m.name}」？`)) return;
    project.modules.splice(i,1);
    if (editingId === id){
      editingId = null;
      $("editingName").textContent = "（未選）";
      $("editor").value = "";
    }
    renderModules(); return;
  }
}

/** ===========
 * Build
 * =========== */
function buildWorker(){
  project.name = $("projectName").value.trim() || project.name;
  project.updatedAt = nowISO();

  const header =
`/**
 * Built by GavinTeam Worker Builder
 * Slot: ${slot.toUpperCase()}
 * Updated: ${project.updatedAt}
 * Enabled: ${project.modules.filter(m=>m.enabled).map(m=>m.name).join(", ")}
 */`;

  const body = project.modules
    .filter(m=>m.enabled)
    .map(m=>`\n\n// ===== MODULE: ${m.name} =====\n${m.code || ""}\n`)
    .join("");

  return `${header}\n${body}\n`;
}

/** ===========
 * Actions
 * =========== */
async function loadSlot(){
  const raw = await gistReadFile(slot);
  let obj;
  try { obj = JSON.parse(raw || "{}"); } catch { obj = {}; }

  if (!obj.modules) obj = DEFAULT_PROJECT();
  project = obj;
  editingId = null;
  $("editingName").textContent = "（未選）";
  $("editor").value = "";
  renderMeta();
  renderModules();
  setMsg(`✅ 已從雲端讀取 ${slot.toUpperCase()}`, true);
}

async function saveSlot(){
  project.name = $("projectName").value.trim() || project.name;
  project.updatedAt = nowISO();
  await gistWriteFile(slot, JSON.stringify(project, null, 2));
  renderMeta();
  setMsg(`✅ 已存到雲端 ${slot.toUpperCase()}`, true);
}

async function copySlot(from, to){
  const raw = await gistReadFile(from);
  await gistWriteFile(to, raw);
  setMsg(`✅ 已複製：${from.toUpperCase()} → ${to.toUpperCase()}`, true);
}

function setSlot(next){
  slot = next;
  slotBadge(slot);
  chips(slot);
  renderMeta();
  // 不自動讀，避免誤覆蓋；由你按「從雲端讀」
}

/** ===========
 * Login
 * =========== */
function showApp(){
  $("loginScreen").classList.add("hidden");
  $("app").classList.remove("hidden");
}

function showLogin(){
  $("app").classList.add("hidden");
  $("loginScreen").classList.remove("hidden");
}

function setLoginMsg(t){ $("loginMsg").textContent = t || ""; }

$("loginBtn").onclick = () => {
  const u = $("user").value.trim();
  const p = $("pass").value.trim();
  if (u === CONFIG.LOGIN_USER && p === CONFIG.LOGIN_PASS) {
    localStorage.setItem("WB_LOGIN_OK", "1");
    showApp();
  } else {
    setLoginMsg("帳號或密碼錯誤");
  }
};

$("logoutBtn").onclick = () => {
  localStorage.removeItem("WB_LOGIN_OK");
  showLogin();
};

/** ===========
 * Wire UI
 * =========== */
$("slotDev").onclick  = () => setSlot("dev");
$("slotProd").onclick = () => setSlot("prod");
$("slotOld").onclick  = () => setSlot("old");

$("loadBtn").onclick = async () => {
  try { await loadSlot(); } catch(e){ setMsg(String(e.message||e), false); }
};

$("saveBtn").onclick = async () => {
  try { await saveSlot(); } catch(e){ setMsg(String(e.message||e), false); }
};

$("devToProdBtn").onclick = async () => {
  try { await copySlot("dev","prod"); } catch(e){ setMsg(String(e.message||e), false); }
};

$("prodToOldBtn").onclick = async () => {
  try { await copySlot("prod","old"); } catch(e){ setMsg(String(e.message||e), false); }
};

$("addModuleBtn").onclick = () => {
  const name = prompt("模組名稱（建議 30_xxx）", "30_new_module");
  if (!name) return;
  project.modules.push({ id: crypto.randomUUID(), name: name.trim(), enabled: true, code: `// ${name.trim()}\n\n` });
  renderModules();
};

$("editor").addEventListener("input", () => {
  if (!editingId) return;
  const m = project.modules.find(x=>x.id===editingId);
  if (m) m.code = $("editor").value;
});

$("templateBtn").onclick = () => {
  if (!editingId) return setMsg("請先點一個模組名稱進入編輯", false);
  const tpl =
`// 範本：新增 handler
// router() 內加入：
// if (url.pathname === "/api/example") return handleExample(request, env, ctx);

async function handleExample(request, env, ctx) {
  return json({ ok: true, from: "handleExample" });
}
`;
  $("editor").value = ($("editor").value || "") + "\n\n" + tpl;
  const m = project.modules.find(x=>x.id===editingId);
  if (m) m.code = $("editor").value;
};

$("formatBtn").onclick = () => {
  if (!editingId) return setMsg("請先點一個模組名稱進入編輯", false);
  $("editor").value = $("editor").value.replace(/\t/g,"  ").replace(/\r\n/g,"\n");
  const m = project.modules.find(x=>x.id===editingId);
  if (m) m.code = $("editor").value;
};

$("buildBtn").onclick = () => {
  $("output").value = buildWorker();
  renderMeta();
  setMsg("✅ 組裝完成：可直接貼到 Cloudflare Worker", true);
};

$("copyBtn").onclick = async () => {
  try{
    await navigator.clipboard.writeText($("output").value || "");
    setMsg("已複製輸出內容");
  }catch{
    setMsg("複製失敗：請先按組裝", false);
  }
};

$("downloadBtn").onclick = () => {
  const content = $("output").value || "";
  if (!content.trim()) return setMsg("請先按組裝", false);
  const blob = new Blob([content], { type: "text/javascript;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "worker.js";
  a.click();
  URL.revokeObjectURL(url);
  setMsg("已下載 worker.js");
};

/** ===========
 * Init
 * =========== */
(function init(){
  // 基本檢查：token 有沒有填
  if (!CONFIG.GITHUB_TOKEN || CONFIG.GITHUB_TOKEN.includes("PASTE_YOUR_TOKEN_HERE")) {
    console.warn("請在 CONFIG.GITHUB_TOKEN 填入你的 token");
  }
  slotBadge(slot);
  chips(slot);
  renderMeta();
  renderModules();

  const ok = localStorage.getItem("WB_LOGIN_OK") === "1";
  ok ? showApp() : showLogin();
})();
</script>

</body>
</html>
